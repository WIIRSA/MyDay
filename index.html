<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#f2f2f7">
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MyDay">
    <meta name="application-name" content="MyDay OS">
    <link rel="icon" href="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/calendar-check-2.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/calendar-check-2.svg">
    <link id="manifest-link" rel="manifest" href="">

    <title>MyDay OS 3.0 - PWA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        /* Base */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            transition: background-image 0.5s ease-in-out, background-color 0.3s ease, color 0.3s ease;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            overscroll-behavior-y: none;
        }

        /* Variables */
        :root {
            --bg-color: #f3f4f6;
            --bg-image-default: radial-gradient(at 0% 0%, hsla(253,16%,90%,1) 0, transparent 50%), 
                                radial-gradient(at 50% 0%, hsla(225,100%,94%,1) 0, transparent 50%), 
                                radial-gradient(at 100% 0%, hsla(339,100%,94%,1) 0, transparent 50%),
                                linear-gradient(120deg, #fdfbfb 0%, #ebedee 100%);
            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(255, 255, 255, 0.4);
            --sidebar-bg: rgba(255, 255, 255, 0.5);
            --text-main: #2c2c2e;
            --text-muted: #8e8e93;
            --card-bg: rgba(255, 255, 255, 0.6);
            --modal-bg: #fafafa;
            --input-bg: rgba(255, 255, 255, 0.5);
            --nav-bg: rgba(255, 255, 255, 0.85);
            --accent-color: #007aff; 
            --toast-bg: #ffffff;
            --toast-border: #e5e5ea;
        }

        [data-theme="dark"] {
            --bg-color: #000000;
            --bg-image-default: none;
            --glass-bg: rgba(28, 28, 30, 0.75);
            --glass-border: rgba(255, 255, 255, 0.1);
            --sidebar-bg: rgba(30, 30, 32, 0.6);
            --text-main: #e5e5e7;
            --text-muted: #98989d;
            --card-bg: rgba(44, 44, 46, 0.5);
            --modal-bg: #1c1c1e;
            --input-bg: #2c2c2e;
            --nav-bg: rgba(28, 28, 30, 0.95);
            --toast-bg: #2c2c2e;
            --toast-border: #3a3a3c;
        }

        body {
            background-color: var(--bg-color);
            background-image: var(--bg-image-default);
            color: var(--text-main);
        }

        /* Utilities */
        .text-accent { color: var(--accent-color) !important; }
        .bg-accent { background-color: var(--accent-color) !important; }
        .border-accent { border-color: var(--accent-color) !important; }
        .ring-accent { --tw-ring-color: var(--accent-color) !important; }
        .btn-primary { background-color: var(--accent-color); color: white; }
        .btn-primary:hover { opacity: 0.9; }

        /* Desktop Glass */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 25px 60px -12px rgba(0, 0, 0, 0.12);
        }
        .glass-sidebar {
            background: var(--sidebar-bg);
            backdrop-filter: blur(40px);
            border-right: 1px solid var(--glass-border);
        }

        .theme-card { background-color: var(--card-bg); border: 1px solid var(--glass-border); }
        .theme-modal { background-color: var(--modal-bg); color: var(--text-main); }
        .theme-input { background-color: var(--input-bg); color: var(--text-main); border: 1px solid transparent; }
        .theme-input:focus { background-color: var(--modal-bg); border-color: var(--accent-color); outline: 2px solid var(--accent-color); outline-offset: -1px; }

        /* Mobile */
        @media (max-width: 768px) {
            body { padding: 0 !important; background-image: none !important; background-color: var(--bg-color) !important; }
            body { background-image: var(--bg-image-default) !important; }
            .glass-panel { width: 100% !important; height: 100dvh !important; max-width: none !important; border-radius: 0 !important; border: none !important; box-shadow: none !important; background: transparent !important; }
            .mobile-hidden { display: none !important; }
            .mobile-flex { display: flex !important; }
            #settings-modal > div { height: 100%; width: 100%; border-radius: 0; }
            .mobile-nav { background-color: var(--nav-bg); border-top: 1px solid var(--glass-border); }
        }

        .toast-notification { background-color: var(--toast-bg); color: var(--text-main); backdrop-filter: blur(20px); border: 1px solid var(--toast-border); box-shadow: 0 8px 24px rgba(0,0,0,0.12); border-radius: 16px; animation: slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideInRight { from { transform: translateX(120%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(0, 0, 0, 0.1); border-radius: 10px; }
        [data-theme="dark"] ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.15); }

        .custom-checkbox input:checked + div { background-color: var(--accent-color); border-color: var(--accent-color); transform: scale(1.05); }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        .sync-badge { font-size: 10px; padding: 2px 6px; border-radius: 99px; display: flex; align-items: center; gap: 4px; font-weight: 600; }
        .sync-active { background-color: rgba(52, 211, 153, 0.2); color: #10b981; }
        .sync-offline { background-color: rgba(156, 163, 175, 0.2); color: #6b7280; }
        [data-theme="dark"] .sync-offline { color: #9ca3af; }
        
        .nav-btn-active { color: var(--accent-color) !important; }
        .settings-tab-active { background-color: var(--card-bg); color: var(--accent-color) !important; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

        /* Masonry Grid for Notes */
        .notes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 1rem;
        }
        @media (min-width: 768px) {
            .notes-grid { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1.5rem; }
        }
        
        /* Color Swatches Grid */
        .color-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(36px, 1fr));
            gap: 0.75rem;
        }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden flex items-center justify-center p-4 selection:bg-blue-500 selection:text-white transition-colors duration-300" id="app-body">

    <!-- Main Container -->
    <main class="w-full max-w-7xl h-[92vh] glass-panel rounded-2xl flex flex-col overflow-hidden relative fade-in">
        
        <!-- Header -->
        <header class="h-14 flex items-center justify-between px-5 border-b shrink-0 select-none z-20 transition-colors relative" style="border-bottom-color: var(--glass-border);">
            
            <!-- Left: Traffic Lights & Title -->
            <div class="flex items-center gap-4 z-20">
                <div class="flex gap-2">
                    <div class="w-3.5 h-3.5 rounded-full bg-[#FF5F57] border border-[#E0443E]/50 cursor-pointer shadow-sm"></div>
                    <div class="w-3.5 h-3.5 rounded-full bg-[#FEBC2E] border border-[#D89E24]/50 cursor-pointer shadow-sm"></div>
                    <div class="w-3.5 h-3.5 rounded-full bg-[#28C840] border border-[#1AAB29]/50 cursor-pointer shadow-sm"></div>
                </div>
                
                <!-- Desktop Title -->
                <div class="hidden md:flex items-center gap-2 text-sm font-semibold tracking-tight opacity-80" style="color: var(--text-main);">
                    <i data-lucide="command" class="w-4 h-4 opacity-70"></i>
                    <span>MyDay OS</span>
                </div>

                <!-- Mobile Title -->
                <div class="md:hidden text-sm font-semibold tracking-tight flex items-center gap-2" style="color: var(--text-main);">
                    <i data-lucide="command" class="w-4 h-4 opacity-70"></i>
                    <span id="header-title">MyDay</span>
                </div>
            </div>
            
            <!-- Center: Desktop Nav Buttons (Segmented Control) -->
            <div class="hidden md:flex absolute left-1/2 transform -translate-x-1/2 gap-1 bg-black/5 dark:bg-white/10 p-1 rounded-lg backdrop-blur-sm z-10 border border-white/5 shadow-inner">
                <button onclick="switchView('productivity')" id="desk-nav-prod" class="px-5 py-1.5 rounded-md text-xs font-bold transition-all bg-white dark:bg-gray-700 shadow-sm text-accent">D칤a</button>
                <button onclick="switchView('notes')" id="desk-nav-notes" class="px-5 py-1.5 rounded-md text-xs font-medium transition-all text-muted hover:bg-white/40 dark:hover:bg-white/20" style="color: var(--text-muted);">Notas</button>
            </div>
            
            <!-- Right: Actions -->
            <div class="flex items-center gap-4 z-20">
                <!-- Indicador de Sincronizaci칩n -->
                <div id="sync-status-indicator" class="hidden sm:flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-medium border transition-all duration-300" title="Estado de Nube">
                    <!-- Contenido inyectado por JS -->
                </div>

                <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition-colors" title="Cambiar Tema">
                    <i id="theme-icon" data-lucide="moon" class="w-5 h-5 opacity-80" style="color: var(--text-main);"></i>
                </button>
                <div id="user-avatar" class="hidden w-6 h-6 rounded-full bg-blue-500 text-white text-xs flex items-center justify-center font-bold overflow-hidden border border-white/20 shadow-sm">
                    <img id="user-photo" src="" alt="User" class="w-full h-full object-cover">
                </div>
                <button onclick="openSettings()" class="text-gray-500 hover:text-gray-800 dark:hover:text-white transition-colors p-1 rounded-md hover:bg-black/5 dark:hover:bg-white/10">
                    <i data-lucide="settings-2" class="w-5 h-5 opacity-80" style="color: var(--text-main);"></i>
                </button>
                <div class="text-right hidden sm:block">
                    <div id="live-clock" class="text-sm font-medium tabular-nums leading-none" style="color: var(--text-main);">--:--</div>
                </div>
            </div>
        </header>

        <!-- APP BODY WRAPPER -->
        <div class="flex flex-1 overflow-hidden relative">
            
            <!-- VISTA: PRODUCTIVIDAD (Agenda + Tareas) -->
            <div id="app-productivity" class="flex flex-1 w-full h-full transition-opacity duration-300">
                <!-- Agenda -->
                <section id="view-agenda" class="w-full md:w-[35%] glass-sidebar flex flex-col md:min-w-[320px] md:max-w-md relative z-10 transition-all mobile-flex">
                    <div class="p-5 pb-2 border-b" style="border-bottom-color: var(--glass-border);">
                        
                        <!-- Navigation Header -->
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-bold flex items-center gap-2 tracking-tight" style="color: var(--text-main);">
                                <i data-lucide="calendar" class="w-5 h-5 text-accent"></i> Agenda
                            </h2>
                            <div class="flex gap-1">
                                <button onclick="changeWeek(-1)" class="p-1.5 rounded-lg hover:bg-black/5 dark:hover:bg-white/10 transition text-muted"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                                <button onclick="goToToday()" class="px-2 py-1 rounded-lg hover:bg-black/5 dark:hover:bg-white/10 transition text-xs font-bold uppercase tracking-wider text-accent">Hoy</button>
                                <button onclick="changeWeek(1)" class="p-1.5 rounded-lg hover:bg-black/5 dark:hover:bg-white/10 transition text-muted"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                            </div>
                        </div>

                        <!-- Month Label & Add Button -->
                        <div class="flex justify-between items-end mb-2 px-1">
                             <span id="current-month-label" class="text-xs font-bold uppercase tracking-widest opacity-50" style="color: var(--text-main);">Cargando...</span>
                             <button onclick="openModal('schedule')" class="w-7 h-7 rounded-full bg-white dark:bg-gray-800 shadow-sm hover:shadow text-accent flex items-center justify-center transition-all hover:scale-105 active:scale-95 border border-black/5 dark:border-white/10">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                            </button>
                        </div>

                        <div class="flex justify-between p-1 rounded-xl mb-2 overflow-x-auto no-scrollbar" id="day-selector" style="background-color: rgba(120, 120, 128, 0.1);"></div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4 space-y-3 pb-24 md:pb-4" id="schedule-list"></div>
                </section>

                <!-- Tareas -->
                <section id="view-tasks" class="flex-1 flex-col relative w-full mobile-hidden md:flex">
                    <div class="p-4 md:p-6 grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-5">
                        <div class="theme-card p-4 rounded-2xl shadow-sm flex flex-col justify-between h-24 md:h-28">
                            <div class="flex justify-between items-start"><span class="text-[10px] md:text-xs font-bold uppercase tracking-wider" style="color: var(--text-muted);">Pendientes</span><i data-lucide="list-todo" class="w-4 h-4 text-orange-500"></i></div>
                            <span class="text-2xl md:text-3xl font-bold" style="color: var(--text-main);" id="pending-count">0</span>
                        </div>
                        <div class="theme-card p-4 rounded-2xl shadow-sm flex flex-col justify-between h-24 md:h-28">
                            <div class="flex justify-between items-start"><span class="text-[10px] md:text-xs font-bold uppercase tracking-wider" style="color: var(--text-muted);">Hoy</span><i data-lucide="clock" class="w-4 h-4 text-accent"></i></div>
                            <span class="text-2xl md:text-3xl font-bold" style="color: var(--text-main);" id="today-events-count">0</span>
                        </div>
                        <div class="theme-card p-4 rounded-2xl shadow-sm flex flex-col justify-between h-24 md:h-28 col-span-2 md:col-span-1">
                            <div class="flex justify-between items-start"><span class="text-[10px] md:text-xs font-bold uppercase tracking-wider" style="color: var(--text-muted);">Historial</span><i data-lucide="check-circle" class="w-4 h-4 text-green-500"></i></div>
                            <span class="text-2xl md:text-3xl font-bold" style="color: var(--text-main);" id="completed-count">0</span>
                        </div>
                    </div>

                    <div class="flex-1 mx-2 md:mx-4 mb-20 md:mb-4 theme-card rounded-2xl shadow-sm flex flex-col overflow-hidden">
                        <div class="p-4 md:p-5 flex justify-between items-center border-b sticky top-0 z-10 backdrop-blur-md" style="border-bottom-color: var(--glass-border); background-color: rgba(255,255,255,0.05);">
                            <div class="flex items-center gap-2">
                                <h3 class="text-lg font-bold" style="color: var(--text-main);">Tareas</h3>
                                <span class="bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-[10px] px-2 py-0.5 rounded-full font-bold" id="total-todos-badge">0</span>
                            </div>
                            <button onclick="openModal('todo')" class="text-sm font-medium px-4 py-2 rounded-xl btn-primary shadow-lg hover:shadow-xl transition-all flex items-center gap-2 active:scale-95">
                                <i data-lucide="plus-circle" class="w-4 h-4"></i> <span class="hidden sm:inline">Nueva</span>
                            </button>
                        </div>
                        <div class="flex-1 overflow-y-auto p-2" id="todo-list"></div>
                    </div>
                </section>
            </div>

            <!-- VISTA: NOTAS (Oculta por defecto) -->
            <div id="app-notes" class="hidden flex-1 w-full h-full p-4 md:p-8 overflow-y-auto pb-24 md:pb-8 animate-fadeIn">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold" style="color: var(--text-main);">Mis Notas</h2>
                    <button onclick="openModal('note')" class="text-sm font-medium px-4 py-2 rounded-xl btn-primary shadow-lg hover:shadow-xl transition-all flex items-center gap-2 active:scale-95">
                        <i data-lucide="plus" class="w-4 h-4"></i> Crear Nota
                    </button>
                </div>
                <div id="notes-grid" class="notes-grid">
                    <!-- Notas Renderizadas Aqu칤 -->
                </div>
            </div>

        </div>

        <!-- BARRA DE NAVEGACI칍N M칍VIL (3 칈conos) -->
        <nav class="md:hidden absolute bottom-0 left-0 right-0 h-20 mobile-nav flex justify-around items-center z-50 pb-safe backdrop-blur-xl px-2">
            <button onclick="switchView('agenda')" class="flex flex-col items-center justify-center w-16 h-14 rounded-xl transition-all nav-btn nav-btn-active" id="btn-nav-agenda" style="color: var(--text-muted);">
                <i data-lucide="calendar-days" class="w-6 h-6 mb-1"></i>
                <span class="text-[10px] font-medium">Agenda</span>
            </button>
            <button onclick="switchView('tasks')" class="flex flex-col items-center justify-center w-16 h-14 rounded-xl transition-all nav-btn" id="btn-nav-tasks" style="color: var(--text-muted);">
                <i data-lucide="check-square" class="w-6 h-6 mb-1"></i>
                <span class="text-[10px] font-medium">Tareas</span>
            </button>
            <button onclick="switchView('notes')" class="flex flex-col items-center justify-center w-16 h-14 rounded-xl transition-all nav-btn" id="btn-nav-notes" style="color: var(--text-muted);">
                <i data-lucide="sticky-note" class="w-6 h-6 mb-1"></i>
                <span class="text-[10px] font-medium">Notas</span>
            </button>
        </nav>

        <!-- Toasts -->
        <div id="toast-container" class="absolute top-16 right-5 z-[60] flex flex-col gap-3 pointer-events-none w-80 max-w-[90vw]"></div>

        <!-- MODAL UNIVERSAL -->
        <div id="modal" class="absolute inset-0 z-50 hidden">
            <div class="absolute inset-0 bg-black/30 backdrop-blur-sm transition-opacity opacity-0" id="modal-backdrop" onclick="closeModal()"></div>
            <div class="absolute inset-0 flex items-end md:items-center justify-center p-0 md:p-4 pointer-events-none">
                <div class="theme-modal w-full md:w-full md:max-w-lg rounded-t-2xl md:rounded-2xl shadow-2xl overflow-hidden transform translate-y-full md:scale-95 md:translate-y-0 opacity-0 transition-all duration-300 pointer-events-auto border border-gray-100 dark:border-gray-700 flex flex-col max-h-[90vh]" id="modal-content">
                    <div class="p-6 overflow-y-auto">
                        <!-- Drag Handle -->
                        <div class="w-12 h-1.5 bg-gray-200 dark:bg-gray-600 rounded-full mx-auto mb-4 md:hidden"></div>
                        
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h3 class="text-xl font-bold" id="modal-title" style="color: var(--text-main);">T칤tulo</h3>
                                <p class="text-sm opacity-60" id="modal-subtitle" style="color: var(--text-main);">Subt칤tulo</p>
                            </div>
                            <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 flex items-center justify-center transition-colors" style="color: var(--text-main);"><i data-lucide="x" class="w-4 h-4"></i></button>
                        </div>
                        
                        <form id="modal-form" onsubmit="handleFormSubmit(event)" class="space-y-5">
                            <div id="form-fields"></div>
                            
                            <!-- Footer Buttons -->
                            <div class="flex justify-end gap-3 pt-4 border-t border-gray-100 dark:border-gray-700 mt-6" id="modal-footer">
                                <!-- Injected dynamically -->
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- SETTINGS MODAL -->
        <div id="settings-modal" class="absolute inset-0 z-50 hidden flex items-end md:items-center justify-center bg-black/30 backdrop-blur-sm p-0 md:p-4">
            <div class="theme-modal w-full h-[85vh] md:h-[500px] md:w-full md:max-w-2xl rounded-t-2xl md:rounded-2xl shadow-2xl flex flex-col md:flex-row overflow-hidden animate-[fadeIn_0.2s_ease-out]">
                <div class="md:hidden p-4 border-b flex justify-between items-center bg-gray-50 dark:bg-gray-800" style="border-bottom-color: var(--glass-border);">
                    <h3 class="font-bold">Ajustes</h3>
                    <button onclick="closeSettings()" class="bg-gray-200 dark:bg-gray-700 p-1.5 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                <div class="w-full md:w-1/3 border-r p-2 md:p-4 flex flex-row md:flex-col gap-2 overflow-x-auto md:overflow-visible no-scrollbar shrink-0" style="background-color: var(--sidebar-bg); border-right-color: var(--glass-border);">
                    <button onclick="switchSettingsTab('general')" class="settings-tab-btn active w-full text-left px-3 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap text-accent" data-tab="general"><i data-lucide="layout" class="w-4 h-4 inline mr-2"></i> General</button>
                    <button onclick="switchSettingsTab('cloud')" class="settings-tab-btn w-full text-left px-3 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap" data-tab="cloud" style="color: var(--text-main);"><i data-lucide="cloud" class="w-4 h-4 inline mr-2"></i> Cloud</button>
                    <button onclick="switchSettingsTab('categories')" class="settings-tab-btn w-full text-left px-3 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap" data-tab="categories" style="color: var(--text-main);"><i data-lucide="tags" class="w-4 h-4 inline mr-2"></i> Categor칤as</button>
                    <button onclick="switchSettingsTab('data')" class="settings-tab-btn w-full text-left px-3 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap" data-tab="data" style="color: var(--text-main);"><i data-lucide="database" class="w-4 h-4 inline mr-2"></i> Datos</button>
                    <button onclick="switchSettingsTab('system')" class="settings-tab-btn w-full text-left px-3 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap" data-tab="system" style="color: var(--text-main);"><i data-lucide="bell" class="w-4 h-4 inline mr-2"></i> Sistema</button>
                </div>
                <div class="flex-1 p-6 md:p-8 overflow-y-auto relative">
                    <button onclick="closeSettings()" class="hidden md:block absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:text-gray-300"><i data-lucide="x" class="w-5 h-5"></i></button>
                    
                    <!-- Pesta침a General -->
                    <div id="tab-general" class="settings-content block">
                        <h2 class="text-xl font-bold mb-4">Personalizaci칩n</h2>
                        
                        <!-- URL Input -->
                        <div class="mb-6">
                            <label class="block text-xs font-bold uppercase mb-2 opacity-60">Imagen Personalizada</label>
                            <div class="flex gap-2">
                                <input type="text" id="bg-url-input" class="theme-input flex-1 rounded-xl px-4 py-2 text-sm outline-none transition-all placeholder-gray-400" placeholder="https://...">
                                <button onclick="saveBackground()" class="btn-primary text-white px-4 py-2 rounded-xl text-sm font-medium transition-colors shadow-sm">Aplicar</button>
                            </div>
                        </div>

                        <!-- Zona Horaria -->
                        <div class="mb-6">
                            <label class="block text-xs font-bold uppercase mb-2 opacity-60">Zona Horaria</label>
                            <select id="timezone-select" onchange="saveTimezone()" class="theme-input w-full rounded-xl px-4 py-2 text-sm outline-none">
                                <option value="system">游 Autom치tico</option>
                                <option value="UTC">UTC (Universal)</option>
                                <option value="America/New_York">游쥟릖 Nueva York (EST)</option>
                                <option value="Europe/London">游섫릖 Londres (GMT)</option>
                                <option value="Europe/Madrid">游쀯릖 Madrid (CET)</option>
                                <option value="Asia/Tokyo">游游 Tokio (JST)</option>
                                <option value="America/Mexico_City">游쓇릖 CDMX (CST)</option>
                                <option value="America/Bogota">游뻟릖 Bogot치 (COT)</option>
                                <option value="America/Argentina/Buenos_Aires">游뷣릖 Buenos Aires (ART)</option>
                                <option value="America/Lima">游왫릖 Lima (PET)</option>
                            </select>
                        </div>

                        <!-- Color de Acento -->
                        <div class="mb-6">
                            <label class="block text-xs font-bold uppercase mb-3 opacity-60">Color de Acento</label>
                            <div class="flex gap-3 flex-wrap" id="accent-colors-container">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <!-- Presets -->
                        <div>
                            <label class="block text-xs font-bold uppercase mb-3 opacity-60">Fondos Predeterminados</label>
                            <div class="flex gap-3 flex-wrap" id="background-presets-container">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>

                    <div id="tab-cloud" class="settings-content hidden">
                        <h2 class="text-xl font-bold mb-4">Sincronizaci칩n Google</h2>
                        <div id="auth-ui" class="text-center py-8">
                            <p class="text-sm mb-4 opacity-70">Guarda tus datos en la nube.</p>
                            <button onclick="loginWithGoogle()" class="bg-white border text-gray-700 px-6 py-3 rounded-xl shadow-sm flex items-center gap-3 w-full justify-center font-medium hover:bg-gray-50"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5"> Conectar Google</button>
                        </div>
                        <div id="user-ui" class="hidden">
                            <div class="bg-green-50 dark:bg-green-900/30 p-4 rounded-xl border border-green-100 dark:border-green-800 mb-4 flex items-center gap-3"><img id="user-img-settings" src="" class="w-10 h-10 rounded-full"><div class="overflow-hidden"><div id="user-name-settings" class="font-bold truncate" style="color: var(--text-main);">Usuario</div><div class="text-xs text-green-700 dark:text-green-400 font-medium">Sincronizaci칩n activa</div></div></div>
                            <button onclick="logout()" class="w-full py-3 text-red-500 font-bold bg-red-50 dark:bg-red-900/20 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-xl">Cerrar Sesi칩n</button>
                        </div>
                    </div>

                    <div id="tab-categories" class="settings-content hidden">
                        <h2 class="text-xl font-bold mb-4">Categor칤as</h2>
                        <form onsubmit="handleAddCategory(event)" class="mb-6 p-4 bg-gray-50 dark:bg-gray-800 rounded-xl border border-gray-100 dark:border-gray-700">
                            <div class="mb-3">
                                <label class="block text-xs font-bold uppercase mb-2 opacity-60">Nombre</label>
                                <input type="text" name="catName" placeholder="Ej. Universidad" class="theme-input w-full px-3 py-2 rounded-lg outline-none text-sm" required>
                            </div>
                            
                            <label class="block text-xs font-bold uppercase mb-2 opacity-60">Color</label>
                            <div class="grid grid-cols-6 gap-2 mb-3" id="cat-color-picker-container">
                                <!-- Colors injected here -->
                            </div>
                            <input type="hidden" name="catColor" id="new-cat-color" value="blue">

                            <div class="mt-4 border-t pt-4 border-gray-200 dark:border-gray-600">
                                <label class="block text-xs font-bold uppercase mb-2 opacity-60">Personalizado</label>
                                <div class="flex items-center gap-2">
                                     <input type="color" id="custom-cat-color" class="w-8 h-8 rounded cursor-pointer border-0 p-0" onchange="document.getElementById('new-cat-color').value = this.value">
                                     <span class="text-xs opacity-50">Elige un tono exacto</span>
                                </div>
                            </div>
                            
                            <button type="submit" class="w-full mt-4 py-2 btn-primary text-white rounded-lg font-medium text-sm">Agregar Categor칤a</button>
                        </form>
                        <div class="text-xs font-bold uppercase mb-3 opacity-60">Existentes</div>
                        <div id="categories-list" class="space-y-2 max-h-60 overflow-y-auto pr-1"></div>
                    </div>

                    <div id="tab-data" class="settings-content hidden">
                        <h2 class="text-xl font-bold mb-4">Datos</h2>
                        <div class="space-y-3">
                            <button onclick="exportData()" class="w-full flex justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-600"><span class="text-sm font-medium">Backup</span><i data-lucide="download" class="w-4 h-4"></i></button>
                            <input type="file" id="import-file" class="hidden" onchange="importData(this)">
                            <button onclick="document.getElementById('import-file').click()" class="w-full flex justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-600"><span class="text-sm font-medium">Restaurar</span><i data-lucide="upload" class="w-4 h-4"></i></button>
                            <button onclick="resetAllData()" class="w-full p-3 text-red-500 text-sm font-bold mt-4">Borrar todo</button>
                        </div>
                    </div>

                    <div id="tab-system" class="settings-content hidden">
                        <h2 class="text-xl font-bold mb-4">Sistema</h2>
                        <div class="flex justify-between p-4 border rounded-xl items-center" style="border-color: var(--glass-border);"><div><h4 class="font-bold text-sm">Notificaciones</h4><p class="text-xs opacity-60">Alertas navegador</p></div><label class="relative inline-flex cursor-pointer"><input type="checkbox" id="browser-notify-toggle" class="sr-only peer" onchange="toggleBrowserNotifications()"><div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label></div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        // CONFIG
        const USER_FIREBASE_CONFIG = { apiKey: "AIzaSyDF3lcFQMX9_wvDpoQjWcT0d4aLeK1dwJ0", authDomain: "myday-3f736.firebaseapp.com", projectId: "myday-3f736", storageBucket: "myday-3f736.firebasestorage.app", messagingSenderId: "245410649722", appId: "1:245410649722:web:fe36ccf0d600e8bbfd0dc3" };

        // Global Variable for View Date
        let viewDate = new Date();

        let state = {
            currentDayIndex: new Date().getDay() === 0 ? 6 : new Date().getDay() - 1,
            schedule: [], todos: [], notes: [],
            categories: [{id:'c1',name:'Clase',color:'blue'}, {id:'c2',name:'Tarea',color:'orange'}, {id:'c3',name:'Ocio',color:'purple'}, {id:'c4',name:'Urgente',color:'red'}],
            settings: { bgUrl: '', browserNotifications: false, theme: 'light', timezone: 'system', accentColor: '#007aff' }
        };
        
        let auth, db, appId, currentUser, isCloudAvailable = false, unsubscribeSnapshot = null, isSaving = false;
        const DAYS_FULL = ['Domingo', 'Lunes', 'Martes', 'Mi칠rcoles', 'Jueves', 'Viernes', 'S치bado'];
        const MONTHS = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        
        // Expanded Color Palette
        const COLORS = { 
            blue:'bg-blue-100 text-blue-700', red:'bg-red-100 text-red-700', green:'bg-green-100 text-green-700', purple:'bg-purple-100 text-purple-700', orange:'bg-orange-100 text-orange-700',
            pink: 'bg-pink-100 text-pink-700', teal: 'bg-teal-100 text-teal-700', indigo: 'bg-indigo-100 text-indigo-700', cyan: 'bg-cyan-100 text-cyan-700', lime: 'bg-lime-100 text-lime-700',
            rose: 'bg-rose-100 text-rose-700', amber: 'bg-amber-100 text-amber-700', sky: 'bg-sky-100 text-sky-700', emerald: 'bg-emerald-100 text-emerald-700', violet: 'bg-violet-100 text-violet-700', gray: 'bg-gray-100 text-gray-700'
        };

        const COLOR_DOTS = {
            blue: '#3b82f6', red: '#ef4444', green: '#22c55e', purple: '#a855f7', orange: '#f97316',
            pink: '#ec4899', teal: '#14b8a6', indigo: '#6366f1', cyan: '#06b6d4', lime: '#84cc16',
            rose: '#f43f5e', amber: '#f59e0b', sky: '#0ea5e9', emerald: '#10b981', violet: '#8b5cf6',
            gray: '#6b7280'
        };
        
        const ACCENT_OPTIONS = [
             { color: '#007aff', name: 'Blue' }, { color: '#af52de', name: 'Purple' },
             { color: '#ff2d55', name: 'Pink' }, { color: '#ff9500', name: 'Orange' },
             { color: '#34c759', name: 'Green' }, { color: '#ff3b30', name: 'Red' }
        ];

        const BACKGROUND_PRESETS = [
            { type: 'nature', url: 'https://images.unsplash.com/photo-1472214103451-9374bd1c798e?w=1600' },
            { type: 'dark', url: 'https://images.unsplash.com/photo-1550684848-fac1c5b4e853?w=1600' },
            { type: 'abstract', url: 'https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?w=1600' },
            { type: 'white', url: '' } // Empty string for default
        ];

        // INIT
        try { firebase.initializeApp(USER_FIREBASE_CONFIG); auth = firebase.auth(); db = firebase.firestore(); appId = USER_FIREBASE_CONFIG.projectId; isCloudAvailable = true; } catch(e) { console.log("Offline"); }

        function init() {
            // PWA Manifest Injection
            const manifest = {
                name: "MyDay OS", short_name: "MyDay", start_url: ".", display: "standalone",
                background_color: "#f2f2f7", theme_color: "#f2f2f7",
                icons: [{ src: "https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/calendar-check-2.svg", sizes: "192x192", type: "image/svg+xml" }]
            };
            const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
            document.getElementById('manifest-link').href = URL.createObjectURL(blob);

            const local = localStorage.getItem('myDayOS_v3');
            if(local) state = {...state, ...JSON.parse(local)};
            
            viewDate = getNowInTimezone();
            
            applyTheme();
            applySettings();
            
            render();
            setupAuthListener();
            setInterval(updateClock, 1000);
            setInterval(checkNotifications, 60000);
            updateClock();
        }

        // --- RENDER SETTINGS UI DYNAMICALLY ---
        function renderSettingsGeneral() {
            // Render Accents
            const accentContainer = document.getElementById('accent-colors-container');
            if (accentContainer) {
                accentContainer.innerHTML = ACCENT_OPTIONS.map(opt => {
                    const isSelected = state.settings.accentColor === opt.color;
                    const ringClass = isSelected ? 'ring-2 ring-offset-2 ring-gray-400 dark:ring-gray-500' : 'ring-2 ring-transparent';
                    return `<button onclick="setAccentColor('${opt.color}')" class="w-8 h-8 rounded-full transition-all ${ringClass}" style="background-color: ${opt.color}" title="${opt.name}"></button>`;
                }).join('');
            }

            // Render Backgrounds
            const bgContainer = document.getElementById('background-presets-container');
            if (bgContainer) {
                bgContainer.innerHTML = BACKGROUND_PRESETS.map(bg => {
                    const isSelected = state.settings.bgUrl === bg.url;
                    // For white preset, we check if url is empty
                    const ringClass = isSelected ? 'ring-4 ring-offset-2 ring-blue-500' : 'ring-2 ring-transparent hover:ring-blue-300';
                    const content = bg.type === 'white' ? '<i data-lucide="ban" class="w-5 h-5 text-gray-400"></i>' : '';
                    const style = bg.type !== 'white' ? `background-image: url('${bg.url}')` : 'background-color: white';
                    const checkIcon = isSelected ? '<div class="absolute inset-0 flex items-center justify-center bg-black/20 rounded-full"><i data-lucide="check" class="w-6 h-6 text-white"></i></div>' : '';
                    
                    return `<button onclick="setPresetBg('${bg.type}')" class="relative w-12 h-12 rounded-full bg-cover transition-all ${ringClass}" style="${style}" title="${bg.type}">
                        ${content}
                        ${checkIcon}
                    </button>`;
                }).join('');
                lucide.createIcons();
            }
        }


        // --- CORE FUNCTIONS ---
        function getNowInTimezone() {
            const now = new Date();
            if (state.settings.timezone === 'system') return now;
            const tzString = new Date().toLocaleString("en-US", {timeZone: state.settings.timezone});
            return new Date(tzString);
        }

        function switchView(view) {
            const prod = document.getElementById('app-productivity');
            const notes = document.getElementById('app-notes');
            const btnProd = document.getElementById('desk-nav-prod');
            const btnNotes = document.getElementById('desk-nav-notes');
            
            // Desktop Nav
            if(view === 'notes') {
                prod.classList.add('hidden');
                notes.classList.remove('hidden');
                btnNotes.classList.remove('text-muted', 'hover:bg-white/40', 'dark:hover:bg-white/20'); 
                btnNotes.classList.add('bg-white', 'dark:bg-gray-700', 'shadow-sm', 'text-accent', 'font-bold');
                
                btnProd.classList.remove('bg-white', 'dark:bg-gray-700', 'shadow-sm', 'text-accent', 'font-bold');
                btnProd.classList.add('text-muted', 'hover:bg-white/40', 'dark:hover:bg-white/20', 'font-medium');
            } else {
                notes.classList.add('hidden');
                prod.classList.remove('hidden');
                
                btnProd.classList.remove('text-muted', 'hover:bg-white/40', 'dark:hover:bg-white/20');
                btnProd.classList.add('bg-white', 'dark:bg-gray-700', 'shadow-sm', 'text-accent', 'font-bold');
                
                btnNotes.classList.remove('bg-white', 'dark:bg-gray-700', 'shadow-sm', 'text-accent', 'font-bold');
                btnNotes.classList.add('text-muted', 'hover:bg-white/40', 'dark:hover:bg-white/20', 'font-medium');
                
                // Handle sub-views for mobile
                if(view === 'agenda' || view === 'tasks') {
                    const agenda = document.getElementById('view-agenda');
                    const tasks = document.getElementById('view-tasks');
                    if(view === 'agenda') {
                        agenda.classList.remove('mobile-hidden'); agenda.classList.add('mobile-flex');
                        tasks.classList.add('mobile-hidden'); tasks.classList.remove('mobile-flex');
                    } else {
                        tasks.classList.remove('mobile-hidden'); tasks.classList.add('mobile-flex');
                        agenda.classList.add('mobile-hidden'); agenda.classList.remove('mobile-flex');
                    }
                }
            }

            // Mobile Nav Active State
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('nav-btn-active');
                btn.style.color = 'var(--text-muted)';
            });
            const activeBtn = document.getElementById(`btn-nav-${view === 'productivity' ? 'agenda' : view}`);
            if(activeBtn) {
                activeBtn.classList.add('nav-btn-active');
                activeBtn.style.color = 'var(--accent-color)';
            }
        }

        function render() {
            renderDays(); renderSchedule(); renderTodos(); renderNotes(); renderStats(); applySettings(); lucide.createIcons();
        }

        function setSyncStatus(status) {
            const el = document.getElementById('sync-status-indicator');
            if (!el) return;
            
            el.classList.remove('hidden', 'sm:flex'); 
            el.classList.add('flex'); 
            
            // Reset base classes
            el.className = 'sync-badge hidden sm:flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-medium transition-all duration-300 border';
            
            let dotClass = '', text = '', containerClass = '';

            if (status === 'syncing') {
                containerClass = 'bg-yellow-50 text-yellow-700 border-yellow-200 dark:bg-yellow-900/20 dark:text-yellow-400 dark:border-yellow-800';
                dotClass = 'bg-yellow-500 animate-pulse'; 
                text = 'Guardando...';
            } else if (status === 'online') {
                containerClass = 'bg-green-50 text-green-700 border-green-200 dark:bg-green-900/20 dark:text-green-400 dark:border-green-800';
                dotClass = 'dot-blink-green'; 
                text = 'En l칤nea';
            } else if (status === 'local') {
                containerClass = 'bg-gray-50 text-gray-600 border-gray-200 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-700';
                dotClass = 'bg-gray-400';
                text = 'Local';
            } else {
                containerClass = 'bg-red-50 text-red-700 border-red-200 dark:bg-red-900/20 dark:text-red-400 dark:border-red-800';
                dotClass = 'bg-red-500';
                text = 'Error';
            }

            el.classList.add(...containerClass.split(' '));
            el.innerHTML = `<div class="w-2 h-2 rounded-full ${dotClass}"></div>${text}`;
        }

        // --- NAVIGATION LOGIC ---
        function changeWeek(offset) {
            // Move viewDate by 7 days
            viewDate.setDate(viewDate.getDate() + (offset * 7));
            render();
        }
        
        function goToToday() {
            viewDate = getNowInTimezone();
            // Reset selection to correct day of week for "today"
            const dayIndex = viewDate.getDay() === 0 ? 6 : viewDate.getDay() - 1;
            state.currentDayIndex = dayIndex;
            render();
        }

        // --- NOTES LOGIC ---
        function renderNotes() {
            const grid = document.getElementById('notes-grid');
            if(!state.notes || state.notes.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center py-20 opacity-50"><i data-lucide="sticky-note" class="w-12 h-12 mx-auto mb-3"></i><p>No hay notas</p></div>';
                return;
            }
            grid.innerHTML = state.notes.map(note => `
                <div class="theme-card p-4 rounded-2xl shadow-sm cursor-pointer hover:shadow-md transition-all relative group break-inside-avoid" style="border-left: 4px solid ${note.color || 'var(--accent-color)'}" onclick="openModal('note', '${note.id}')">
                    <h3 class="font-bold text-lg mb-1 line-clamp-1" style="color:var(--text-main)">${note.title}</h3>
                    <p class="text-sm opacity-70 line-clamp-4 whitespace-pre-wrap" style="color:var(--text-main)">${note.content}</p>
                    <div class="mt-3 text-[10px] opacity-40 font-medium">${new Date(note.date).toLocaleDateString()}</div>
                    <button onclick="event.stopPropagation(); deleteItem('note', '${note.id}')" class="absolute top-2 right-2 p-1 opacity-0 group-hover:opacity-100 transition-opacity text-red-500 hover:bg-red-50 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
            `).join('');
        }

        // --- MODALS & FORMS ---
        let modalConfig = {};
        function openModal(type, id = null) {
            modalConfig = {type, id};
            const modal = document.getElementById('modal'), content = document.getElementById('modal-content'), backdrop = document.getElementById('modal-backdrop'), fields = document.getElementById('form-fields');
            let data = null;
            if(id) {
                if(type === 'schedule') data = state.schedule.find(x => x.id === id);
                else if(type === 'todo') data = state.todos.find(x => x.id === id);
                else if(type === 'note') data = state.notes.find(x => x.id === id);
            }
            
            // Branch logic: View Mode (Read Only) or Edit/Create Mode
            if (id && (type === 'note' || type === 'schedule')) {
                 renderViewMode(type, data);
            } else {
                 renderEditMode(type, data);
            }

            modal.classList.remove('hidden'); 
            setTimeout(() => { 
                backdrop.classList.remove('opacity-0'); 
                content.classList.add('md:scale-100', 'translate-y-0'); 
                content.classList.remove('translate-y-full', 'opacity-0', 'md:scale-95'); 
            }, 10);
        }

        function renderViewMode(type, data) {
            const fields = document.getElementById('form-fields');
            const footer = document.getElementById('modal-footer');
            document.getElementById('modal-title').innerText = 'Detalles';
            document.getElementById('modal-subtitle').innerText = type === 'note' ? 'Vista previa' : 'Evento';
            
            let contentHtml = '';
            if (type === 'note') {
                contentHtml = `
                    <div class="space-y-6">
                        <h3 class="text-2xl font-bold text-gray-900 dark:text-white leading-tight border-b pb-4 border-gray-100 dark:border-gray-700">${data.title}</h3>
                        <div class="text-gray-700 dark:text-gray-300 whitespace-pre-wrap leading-relaxed text-lg min-h-[100px]">${data.content}</div>
                        <div class="flex items-center gap-2 mt-4">
                           <div class="w-3 h-3 rounded-full" style="background-color: ${data.color || 'var(--accent-color)'}"></div>
                           <span class="text-xs text-gray-400">${new Date(data.date).toLocaleDateString()}</span>
                        </div>
                    </div>
                `;
            } else if (type === 'schedule') {
                const dateDisplay = data.specificDate ? 
                    new Date(data.specificDate + 'T00:00').toLocaleDateString('es-ES', {weekday: 'long', day: 'numeric', month: 'long'}) : 
                    `Todos los ${data.day}`;
                    
                contentHtml = `
                    <div class="space-y-5">
                        <h3 class="text-2xl font-bold text-gray-900 dark:text-white">${data.title}</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded-xl">
                                 <span class="block text-xs text-gray-500 mb-1">Hora</span>
                                 <span class="font-bold text-gray-800 dark:text-gray-200 text-lg">${data.time}</span>
                            </div>
                            <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded-xl">
                                 <span class="block text-xs text-gray-500 mb-1">Fecha</span>
                                 <span class="font-bold text-gray-800 dark:text-gray-200 text-sm capitalize">${dateDisplay}</span>
                            </div>
                        </div>
                        ${data.desc ? `
                        <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-xl">
                            <span class="block text-xs text-gray-500 mb-2">Notas</span>
                            <p class="text-gray-700 dark:text-gray-300 whitespace-pre-wrap">${data.desc}</p>
                        </div>` : ''}
                    </div>
                `;
            }
            fields.innerHTML = contentHtml;
            
            footer.innerHTML = `
                <button type="button" onclick="closeModal()" class="px-5 py-3 md:py-2.5 rounded-xl text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 font-medium transition text-sm flex-1 md:flex-none justify-center flex">Cerrar</button>
                <button type="button" onclick="renderEditMode('${type}', state.${type === 'schedule' ? 'schedule' : 'notes'}.find(x=>x.id==='${data.id}'))" class="w-full md:w-auto px-6 py-3 md:py-2.5 rounded-xl bg-gray-900 dark:bg-blue-600 text-white font-medium shadow-lg hover:shadow-xl transition transform active:scale-95 flex items-center justify-center gap-2">
                    <i data-lucide="pencil" class="w-4 h-4"></i> Editar
                </button>
            `;
            lucide.createIcons();
        }

        window.renderEditMode = function(type, data = null) {
             const fields = document.getElementById('form-fields');
             const footer = document.getElementById('modal-footer');
             const inputClass = "w-full px-4 py-3 rounded-xl theme-input border outline-none transition-colors";
             
             document.getElementById('modal-title').innerText = data ? 'Editar' : 'Nuevo';
             document.getElementById('modal-subtitle').innerText = type === 'note' ? 'Escribe tu nota' : (type === 'schedule' ? 'Detalles del evento' : 'Tarea');
             
             if (type === 'note') {
                const colors = ['#007aff', '#ff9500', '#34c759', '#ff2d55', '#af52de'];
                const colorPicker = colors.map(c => `
                    <div onclick="selectNoteColor('${c}', this)" class="w-8 h-8 rounded-full cursor-pointer ring-2 ring-offset-2 transition-transform ${data && data.color === c ? 'ring-gray-400' : 'ring-transparent'} hover:scale-110" style="background-color: ${c}"></div>
                `).join('');
                fields.innerHTML = `
                    <div class="mb-4">
                        <input type="text" name="title" value="${data?data.title:''}" required class="${inputClass} font-bold text-lg" placeholder="T칤tulo de la nota">
                    </div>
                    <textarea name="content" class="${inputClass} h-40 resize-none" placeholder="Escribe aqu칤...">${data?data.content:''}</textarea>
                    <div class="flex gap-3 pt-2 justify-center" id="note-color-picker-container">${colorPicker}</div>
                    <input type="hidden" name="color" id="note-color-input" value="${data?data.color:'#007aff'}">
                `;
            } else if(type === 'schedule') {
                const cats = state.categories.map(c=>`<option value="${c.id}" ${data&&data.categoryId===c.id?'selected':''}>${c.name}</option>`).join('');
                const days = DAYS_FULL.map(d=>`<option value="${d}" ${(data&&data.day===d)||(!data&&DAYS_FULL[getNowInTimezone().getDay()]===d)?'selected':''}>${d}</option>`).join('');
                
                let prefillDate = '';
                if (data && data.specificDate) prefillDate = data.specificDate;
                else {
                    const monday = new Date(viewDate);
                    const currentDayNum = monday.getDay();
                    const diff = monday.getDate() - currentDayNum + (currentDayNum === 0 ? -6 : 1);
                    monday.setDate(diff);
                    const selectedDate = new Date(monday);
                    selectedDate.setDate(monday.getDate() + state.currentDayIndex);
                    prefillDate = selectedDate.toISOString().split('T')[0];
                }

                const isRecurring = data ? !data.specificDate : true;

                fields.innerHTML = `
                    <div class="mb-5"><label class="text-xs font-bold uppercase mb-1 opacity-60">T칤tulo</label><input type="text" name="title" value="${data?data.title:''}" required class="${inputClass}" placeholder="Ej. Examen"></div>
                    
                    <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded-xl border border-gray-100 dark:border-gray-700">
                        <label class="flex items-center gap-3 cursor-pointer mb-3">
                            <input type="checkbox" id="is-recurring" class="w-5 h-5 rounded text-accent focus:ring-0" ${isRecurring ? 'checked' : ''} onchange="toggleRecurrence()">
                            <span class="text-sm font-medium">Repetir todas las semanas</span>
                        </label>
                        
                        <div id="date-input-container" class="${isRecurring ? 'hidden' : ''}">
                            <label class="text-xs font-bold uppercase mb-1 opacity-60">Fecha</label>
                            <input type="date" name="specificDate" value="${prefillDate}" class="${inputClass}">
                        </div>

                        <div id="day-select-container" class="${!isRecurring ? 'hidden' : ''}">
                            <label class="text-xs font-bold uppercase mb-1 opacity-60">D칤a de la semana</label>
                            <select name="day" class="${inputClass}">
                                ${DAYS_FULL.map(d=>`<option value="${d}" ${(data&&data.day===d)||(!data&&DAYS_FULL[new Date(prefillDate).getDay()===0?0:new Date(prefillDate).getDay()]===d)?'selected':''}>${d}</option>`).join('')}
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mt-2">
                        <div><label class="text-xs font-bold uppercase mb-1 opacity-60">Hora</label><input type="time" name="time" value="${data?data.time:'09:00'}" required class="${inputClass}"></div>
                        <div><label class="text-xs font-bold uppercase mb-1 opacity-60">Categor칤a</label><select name="categoryId" class="${inputClass}">${cats}</select></div>
                    </div>
                    <div class="mt-4"><label class="text-xs font-bold uppercase mb-1 opacity-60">Notas</label><textarea name="desc" class="${inputClass} h-20 resize-none">${data?data.desc||'':''}</textarea></div>
                `;
            } else {
                const cats = state.categories.map(c=>`<option value="${c.id}" ${data&&data.categoryId===c.id?'selected':''}>${c.name}</option>`).join('');
                const deadlineDate = data?.deadline ? new Date(data.deadline).toISOString().split('T')[0] : '';
                const deadlineTime = data?.deadline ? new Date(data.deadline).toTimeString().substring(0,5) : '';

                fields.innerHTML = `
                    <div class="mb-4">
                        <label class="text-xs font-bold uppercase mb-1 opacity-60">Tarea</label>
                        <input type="text" name="text" value="${data?data.text:''}" required class="${inputClass}" placeholder="Ej. Comprar leche">
                    </div>
                    <div class="mb-4">
                        <label class="text-xs font-bold uppercase mb-1 opacity-60">Categor칤a</label>
                        <select name="categoryId" class="${inputClass}">${cats}</select>
                    </div>
                    
                    <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded-xl border border-gray-100 dark:border-gray-700">
                        <div class="text-xs font-bold uppercase mb-2 opacity-60">Fecha L칤mite (Opcional)</div>
                        <div class="grid grid-cols-2 gap-3">
                            <input type="date" name="deadlineDate" value="${deadlineDate}" class="${inputClass}">
                            <input type="time" name="deadlineTime" value="${deadlineTime}" class="${inputClass}">
                        </div>
                    </div>
                `;
            }
            
            footer.innerHTML = `
                <button type="button" onclick="closeModal()" class="px-5 py-3 md:py-2.5 rounded-xl text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 font-medium transition text-sm flex-1 md:flex-none justify-center flex">Cancelar</button>
                <button type="submit" class="px-6 py-3 md:py-2.5 rounded-xl btn-primary font-medium shadow-lg shadow-blue-500/20 transition transform active:scale-95 text-sm flex items-center justify-center gap-2 flex-1 md:flex-none"><i data-lucide="save" class="w-4 h-4"></i> Guardar</button>
            `;
            lucide.createIcons();
        }

        window.toggleRecurrence = function() {
            const isRecurring = document.getElementById('is-recurring').checked;
            const dateContainer = document.getElementById('date-input-container');
            const dayContainer = document.getElementById('day-select-container');
            if (isRecurring) { dateContainer.classList.add('hidden'); dayContainer.classList.remove('hidden'); } 
            else { dateContainer.classList.remove('hidden'); dayContainer.classList.add('hidden'); }
        }

        window.selectNoteColor = function(c, el) {
            document.getElementById('note-color-input').value = c;
            const container = document.getElementById('note-color-picker-container');
            Array.from(container.children).forEach(child => {
                child.classList.remove('ring-gray-400');
                child.classList.add('ring-transparent');
            });
            el.classList.remove('ring-transparent');
            el.classList.add('ring-gray-400');
        }

        function closeModal() {
            const modal = document.getElementById('modal'), content = document.getElementById('modal-content'), backdrop = document.getElementById('modal-backdrop');
            content.classList.remove('md:scale-100', 'translate-y-0'); content.classList.add('translate-y-full', 'opacity-0', 'md:scale-95'); backdrop.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function handleFormSubmit(e) {
            e.preventDefault(); const fd = new FormData(e.target); const { type, mode, id } = modalConfig;
            if (type === 'note') {
                const item = { id: id||Date.now().toString(), title: fd.get('title'), content: fd.get('content'), color: fd.get('color'), date: new Date().toISOString() };
                if(id) { const idx = state.notes.findIndex(x=>x.id===id); state.notes[idx]=item; } else { if(!state.notes) state.notes=[]; state.notes.unshift(item); }
            } else if(type === 'schedule') {
                const isRecurring = document.getElementById('is-recurring').checked;
                const item = { 
                    id: id||Date.now().toString(), 
                    title: fd.get('title'), time: fd.get('time'), categoryId: fd.get('categoryId'), desc: fd.get('desc'),
                    day: isRecurring ? fd.get('day') : DAYS_FULL[new Date(fd.get('specificDate')).getDay() === 0 ? 0 : new Date(fd.get('specificDate')).getDay()],
                    specificDate: isRecurring ? null : fd.get('specificDate')
                };
                if(id) { const idx = state.schedule.findIndex(x=>x.id===id); state.schedule[idx]=item; } else state.schedule.push(item);
            } else {
                let deadline = null;
                const dDate = fd.get('deadlineDate'); const dTime = fd.get('deadlineTime');
                if (dDate) { deadline = new Date(`${dDate}T${dTime || '23:59'}`).toISOString(); }
                const item = { 
                    id: id||Date.now().toString(), 
                    text: fd.get('text'), categoryId: fd.get('categoryId'), completed: id?state.todos.find(x=>x.id===id).completed:false,
                    deadline: deadline
                };
                if(id) { const idx = state.todos.findIndex(x=>x.id===id); state.todos[idx]=item; } else state.todos.push(item);
            }
            saveData(); closeModal(); render();
        }

        function deleteItem(type, id) { if(confirm('쮼liminar?')) { 
            if(type==='schedule') state.schedule=state.schedule.filter(i=>i.id!==id); 
            else if(type==='note') state.notes=state.notes.filter(i=>i.id!==id);
            else state.todos=state.todos.filter(i=>i.id!==id); 
            saveData(); render(); closeModal(); 
        }}
        
        function toggleTodo(id) { const t = state.todos.find(i=>i.id===id); if(t) { t.completed = !t.completed; saveData(); render(); } }
        
        // --- CATEGORIES ---
        function handleAddCategory(e) { 
            e.preventDefault(); const fd = new FormData(e.target); 
            state.categories.push({id:'c'+Date.now(), name:fd.get('catName'), color:fd.get('catColor')}); 
            saveData(); renderCategoriesList(); e.target.reset(); 
        }
        function deleteCategory(id) { if(state.categories.length>1 && confirm('쮹orrar?')) { state.categories = state.categories.filter(c=>c.id!==id); saveData(); renderCategoriesList(); } }
        function renderCategoriesList() {
            const container = document.getElementById('categories-list');
            const picker = document.getElementById('cat-color-picker-container');
            if(picker) {
                picker.innerHTML = Object.keys(COLOR_DOTS).map(k => `
                    <div onclick="selectCatColor('${k}', this)" class="w-8 h-8 rounded-full cursor-pointer hover:scale-110 transition-transform ring-2 ring-transparent hover:ring-gray-300" style="background-color: ${COLOR_DOTS[k]}"></div>
                `).join('');
            }

            container.innerHTML = state.categories.map(c => {
                const isHex = c.color.startsWith('#');
                const dotStyle = isHex ? `background-color: ${c.color}` : `background-color: ${COLOR_DOTS[c.color] || '#ccc'}`;
                return `<div class="flex justify-between p-2 theme-card rounded-lg items-center mb-2">
                    <div class="flex items-center gap-3">
                        <div class="w-4 h-4 rounded-full" style="${dotStyle}"></div>
                        <span class="text-sm font-medium" style="color:var(--text-main)">${c.name}</span>
                    </div>
                    <button onclick="deleteCategory('${c.id}')" class="text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>`;
            }).join('');
            lucide.createIcons();
        }

        window.selectCatColor = function(c, el) { 
            document.getElementById('new-cat-color').value = c;
            // Visual feedback for category color picker
            if (el) {
                const container = document.getElementById('cat-color-picker-container');
                Array.from(container.children).forEach(child => {
                    child.classList.remove('ring-gray-400');
                    child.classList.add('ring-transparent');
                });
                el.classList.remove('ring-transparent');
                el.classList.add('ring-gray-400');
            }
        }

        function renderStats() {
            const today = DAYS_FULL[getNowInTimezone().getDay()];
            const pEl = document.getElementById('pending-count'); if(pEl) pEl.textContent = state.todos.filter(t => !t.completed).length;
            const cEl = document.getElementById('completed-count'); if(cEl) cEl.textContent = state.todos.filter(t => t.completed).length;
            const tEl = document.getElementById('today-events-count'); if(tEl) tEl.textContent = state.schedule.filter(s => s.day === today).length;
            const bEl = document.getElementById('total-todos-badge'); if(bEl) bEl.textContent = state.todos.length;
        }

        function renderDays() {
            const now = getNowInTimezone(); const currentDayNum = now.getDay(); const diff = now.getDate() - currentDayNum + (currentDayNum === 0 ? -6 : 1); const systemNow = new Date(); const monday = new Date(systemNow.setDate(diff)); const todayString = now.toDateString();
            const monthLabel = document.getElementById('current-month-label');
            if (monthLabel) { const monthName = MONTHS[viewDate.getMonth()]; const year = viewDate.getFullYear(); monthLabel.textContent = `${monthName} ${year}`; }
            let html = '';
            for(let i=0; i<7; i++) {
                let d = new Date(monday); d.setDate(monday.getDate() + i);
                const isSel = i === state.currentDayIndex; const isToday = d.toDateString() === todayString; 
                const dayNameShort = DAYS_FULL[d.getDay() === 0 ? 0 : d.getDay()].substring(0,3);
                const selStyle = isSel ? `color: var(--accent-color);` : `color: var(--text-muted);`;
                const todayDot = isToday ? `<span class="w-1 h-1 rounded-full mt-1 bg-accent"></span>` : '';
                const activeClass = isSel ? 'bg-white dark:bg-gray-700 shadow-md scale-105' : 'bg-transparent';
                html += `<button onclick="setDay(${i})" class="flex flex-col items-center justify-center min-w-[3.5rem] h-14 rounded-xl transition-all ${activeClass}" style="${selStyle}"><span class="text-[10px] font-bold uppercase">${dayNameShort}</span><span class="text-lg font-bold">${d.getDate()}</span>${todayDot}</button>`;
            }
            document.getElementById('day-selector').innerHTML = html;
        }
        function setDay(i) { state.currentDayIndex = i; render(); }
        function goToToday() { viewDate = getNowInTimezone(); const dayIndex = now.getDay() === 0 ? 6 : now.getDay() - 1; state.currentDayIndex = dayIndex; render(); }

        function renderSchedule() {
            const list = document.getElementById('schedule-list'); const now = new Date(); const diff = now.getDate() - now.getDay() + (now.getDay() === 0 ? -6 : 1); const monday = new Date(now.setDate(diff)); const selectedDate = new Date(monday); selectedDate.setDate(monday.getDate() + state.currentDayIndex); const dayName = DAYS_FULL[selectedDate.getDay() === 0 ? 0 : selectedDate.getDay()];
            const items = state.schedule.filter(s => s.day === dayName).sort((a,b)=>a.time.localeCompare(b.time));
            if(items.length === 0) { list.innerHTML = `<div class="flex flex-col items-center justify-center h-64 opacity-40"><i data-lucide="coffee" class="w-12 h-12 mb-2"></i><p class="text-sm">Nada para el ${dayName}</p></div>`; return; }
            list.innerHTML = items.map(item => {
                const cat = state.categories.find(c=>c.id===item.categoryId) || {color:'gray', name:''};
                // Handle colors (hex or preset)
                const isHex = cat.color.startsWith('#');
                const dotStyle = isHex ? `background-color: ${cat.color}` : `background-color: ${COLOR_DOTS[cat.color] || '#ccc'}`;
                
                return `<div class="theme-card backdrop-blur-md p-4 rounded-2xl shadow-sm flex gap-4 active:scale-[0.98] transition-transform relative group" onclick="openModal('schedule', '${item.id}')"><div class="flex flex-col items-center w-12 border-r border-gray-200 dark:border-gray-700 pr-2 pt-1"><span class="font-bold text-sm" style="color: var(--text-main);">${item.time}</span></div><div class="flex-1 min-w-0 pr-8"><div class="flex items-center gap-2 mb-1"><span class="w-2 h-2 rounded-full" style="${dotStyle}"></span><span class="text-xs font-bold uppercase tracking-wider" style="color: var(--text-muted);">${cat.name}</span></div><h3 class="font-bold truncate text-lg" style="color: var(--text-main);">${item.title}</h3>${item.desc ? `<p class="text-sm truncate" style="color: var(--text-muted);">${item.desc}</p>` : ''}</div><button onclick="event.stopPropagation(); deleteItem('schedule', '${item.id}')" class="absolute top-4 right-4 p-1.5 opacity-40 hover:opacity-100 hover:text-red-500 rounded-lg transition-all" title="Eliminar"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`;
            }).join('');
        }

        function renderTodos() {
            const list = document.getElementById('todo-list'); const items = state.todos.sort((a,b) => a.completed - b.completed);
            if(items.length === 0) { list.innerHTML = '<div class="p-8 text-center text-sm opacity-50">Sin tareas pendientes</div>'; return; }
            list.innerHTML = items.map(item => {
                const cat = state.categories.find(c=>c.id===item.categoryId) || {color:'gray', name:''};
                
                // Dynamic styling for tags
                const isHex = cat.color.startsWith('#');
                let tagStyle = '';
                let tagClass = 'text-[10px] font-bold px-1.5 py-0.5 rounded';
                
                if (isHex) {
                    tagStyle = `background-color: ${cat.color}20; color: ${cat.color};`; // 20% opacity bg
                } else {
                    tagClass += ` ${COLORS[cat.color] || 'bg-gray-100 text-gray-500'}`;
                }
                
                // Deadline Logic
                let deadlineHtml = '';
                if (item.deadline) {
                    const d = new Date(item.deadline);
                    const now = new Date();
                    const isOverdue = d < now && !item.completed;
                    const dateStr = d.toLocaleDateString('es-ES', {month: 'short', day: 'numeric'});
                    const timeStr = d.toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'});
                    
                    const colorClass = isOverdue ? 'text-red-500 font-bold' : 'text-gray-400';
                    deadlineHtml = `<div class="flex items-center gap-1 text-[10px] mt-1 ${colorClass}"><i data-lucide="clock" class="w-3 h-3"></i> ${dateStr} ${timeStr}</div>`;
                }

                return `<div class="flex items-center gap-3 p-3 mb-3 theme-card rounded-xl active:bg-gray-50 dark:active:bg-gray-700 transition border-b dark:border-gray-700 last:border-0 last:mb-0"><label class="custom-checkbox relative flex items-center justify-center w-6 h-6"><input type="checkbox" class="sr-only" ${item.completed?'checked':''} onchange="toggleTodo('${item.id}')"><div class="w-5 h-5 border-2 border-gray-300 dark:border-gray-500 rounded-md transition-colors flex items-center justify-center"><i data-lucide="check" class="w-3.5 h-3.5 text-white"></i></div></label><div class="flex-1 min-w-0" onclick="openModal('todo', '${item.id}')"><p class="font-medium ${item.completed?'line-through opacity-50':''}" style="color: var(--text-main);" class="truncate text-base">${item.text}</p><div class="flex items-center gap-2 mt-1"><span class="${tagClass}" style="${tagStyle}">${cat.name}</span>${deadlineHtml}</div></div><button onclick="deleteItem('todo','${item.id}')" class="opacity-40 hover:opacity-100 hover:text-red-500 p-2"><i data-lucide="x" class="w-4 h-4"></i></button></div>`;
            }).join('');
        }

        function updateClock() {
            const now = new Date(); const timeOptions = { hour: '2-digit', minute: '2-digit' }; const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            if (state.settings.timezone !== 'system') { timeOptions.timeZone = state.settings.timezone; dateOptions.timeZone = state.settings.timezone; }
            const timeStr = now.toLocaleTimeString('es-ES', timeOptions); const dateFull = now.toLocaleDateString('es-ES', dateOptions);
            const timeEl = document.getElementById('live-clock'); if(timeEl) timeEl.textContent = timeStr;
        }

        function saveTimezone() { const select = document.getElementById('timezone-select'); state.settings.timezone = select.value; saveData(); updateClock(); renderDays(); renderSchedule(); setSyncStatus('syncing'); setTimeout(() => setSyncStatus('online'), 1000); }
        function toggleTheme() { state.settings.theme = state.settings.theme === 'light' ? 'dark' : 'light'; saveData(); applyTheme(); }
        function applyTheme() {
            const html = document.documentElement; const icon = document.getElementById('theme-icon');
            if (state.settings.theme === 'dark') { html.setAttribute('data-theme', 'dark'); html.classList.add('dark'); if(icon) { icon.setAttribute('data-lucide', 'sun'); icon.innerHTML = '<circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path>'; } } 
            else { html.removeAttribute('data-theme'); html.classList.remove('dark'); if(icon) { icon.setAttribute('data-lucide', 'moon'); icon.innerHTML = '<path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path>'; } }
        }
        function setAccentColor(color) { 
            state.settings.accentColor = color; 
            saveData(); 
            applySettings(); 
            render(); 
            renderSettingsGeneral(); // Refresh settings UI to show selection
        }
        function setupAuthListener() {
            if(!isCloudAvailable) return;
            auth.onAuthStateChanged(user => {
                currentUser = user;
                if(user) {
                    document.getElementById('auth-ui').classList.add('hidden'); document.getElementById('user-ui').classList.remove('hidden'); document.getElementById('user-avatar').classList.remove('hidden'); document.getElementById('user-photo').src = user.photoURL; document.getElementById('user-img-settings').src = user.photoURL; document.getElementById('user-name-settings').innerText = user.displayName;
                    setSyncStatus('online');
                    activateFirestoreSync(user.uid);
                } else {
                    document.getElementById('auth-ui').classList.remove('hidden'); document.getElementById('user-ui').classList.add('hidden'); document.getElementById('user-avatar').classList.add('hidden');
                    setSyncStatus('local');
                    if(unsubscribeSnapshot) unsubscribeSnapshot();
                }
            });
        }
        function activateFirestoreSync(uid) {
            if(unsubscribeSnapshot) unsubscribeSnapshot();
            const docRef = db.collection('artifacts').doc(appId).collection('users').doc(uid).collection('data').doc('main');
            let firstLoad = true;
            unsubscribeSnapshot = docRef.onSnapshot((doc) => {
                if(doc.exists && !isSaving) {
                    const remoteData = doc.data();
                    state.schedule = remoteData.schedule || []; state.todos = remoteData.todos || []; state.categories = remoteData.categories || state.categories; 
                    state.notes = remoteData.notes || []; // Sync Notes
                    if(remoteData.settings) { state.settings = {...state.settings, ...remoteData.settings}; }
                    render();
                    setSyncStatus('online');
                } else if(!doc.exists && (state.schedule.length > 0 || state.todos.length > 0 || state.notes.length > 0)) { saveDataToCloud(); }
                firstLoad = false;
            });
        }
        function loginWithGoogle() { const p = new firebase.auth.GoogleAuthProvider(); auth.signInWithPopup(p); }
        function logout() { auth.signOut(); }
        async function saveData() { localStorage.setItem('myDayOS_v3', JSON.stringify(state)); renderStats(); if(isCloudAvailable && currentUser) saveDataToCloud(); }
        let saveTimeout; function saveDataToCloud() { 
            if (!isCloudAvailable || !currentUser) return; 
            clearTimeout(saveTimeout); 
            isSaving = true; 
            setSyncStatus('syncing');
            saveTimeout = setTimeout(async () => { 
                try { 
                    const docRef = db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid).collection('data').doc('main'); 
                    await docRef.set({ schedule: state.schedule, todos: state.todos, notes: state.notes, categories: state.categories, settings: state.settings, lastUpdated: new Date() }); 
                    setSyncStatus('online');
                } catch(e) { 
                    console.error(e); 
                    setSyncStatus('error');
                } 
                isSaving = false; 
            }, 1000); 
        }
        function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); const tzSelect = document.getElementById('timezone-select'); if(tzSelect) tzSelect.value = state.settings.timezone || 'system'; const bgInput = document.getElementById('bg-url-input'); if(bgInput) bgInput.value = state.settings.bgUrl || ''; renderSettingsGeneral(); switchSettingsTab('general'); renderCategoriesList(); }
        function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }
        function switchSettingsTab(tabId) { document.querySelectorAll('.settings-content').forEach(el => el.classList.add('hidden')); document.getElementById('tab-' + tabId).classList.remove('hidden'); document.querySelectorAll('.settings-tab-btn').forEach(btn => { if(btn.dataset.tab === tabId) { btn.classList.add('settings-tab-active'); btn.style.color = 'var(--accent-color)'; } else { btn.classList.remove('settings-tab-active'); btn.style.color = 'var(--text-main)'; } }); }
        function checkNotifications() { const now = getNowInTimezone(); const hours = now.getHours().toString().padStart(2, '0'); const minutes = now.getMinutes().toString().padStart(2, '0'); const currentTime = `${hours}:${minutes}`; const currentDayName = DAYS_FULL[now.getDay()]; const events = state.schedule.filter(s => s.day === currentDayName && s.time === currentTime); events.forEach(event => { showToast(`Es hora: ${event.title}`, 'Recordatorio'); if (state.settings.browserNotifications && Notification.permission === "granted") { try { new Notification("MyDay OS", { body: `Evento: ${event.title}`, icon: "https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/clock.svg", tag: `evt-${event.id}`, requireInteraction: true }); } catch (e) {} } }); }
        function toggleBrowserNotifications() { const checkbox = document.getElementById('browser-notify-toggle'); if (checkbox.checked) { if (!("Notification" in window)) return alert("No soportado"); Notification.requestPermission().then(p => { if (p === "granted") { state.settings.browserNotifications = true; saveData(); new Notification("MyDay OS", { body: "Activado" }); } else { checkbox.checked = false; state.settings.browserNotifications = false; saveData(); alert("Permiso denegado"); } }); } else { state.settings.browserNotifications = false; saveData(); } }
        function showToast(msg, title) { const c = document.getElementById('toast-container'); const t = document.createElement('div'); t.className = 'toast-notification p-4 flex gap-3 items-start cursor-pointer'; t.onclick = () => t.remove(); t.innerHTML = `<div class="bg-accent/20 p-2 rounded-full text-accent shrink-0"><i data-lucide="bell" class="w-5 h-5"></i></div><div><h4 class="text-sm font-bold">${title}</h4><p class="text-xs opacity-80">${msg}</p></div>`; c.appendChild(t); lucide.createIcons(); setTimeout(() => { t.style.animation = 'slideInRight 0.4s reverse forwards'; setTimeout(()=>t.remove(), 400); }, 5000); }
        function applySettings() { if(state.settings.bgUrl) document.body.style.backgroundImage = `url('${state.settings.bgUrl}')`; else document.body.style.backgroundImage = 'none'; const t = document.getElementById('browser-notify-toggle'); if(t) t.checked = state.settings.browserNotifications; const tzSelect = document.getElementById('timezone-select'); if(tzSelect) tzSelect.value = state.settings.timezone || 'system'; const accent = state.settings.accentColor || '#007aff'; document.documentElement.style.setProperty('--accent-color', accent); }
        function setPresetBg(type) { if(type==='white') state.settings.bgUrl = ''; else { const urls = {nature:'https://images.unsplash.com/photo-1472214103451-9374bd1c798e?w=1600', dark:'https://images.unsplash.com/photo-1550684848-fac1c5b4e853?w=1600', abstract: 'https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?w=1600'}; state.settings.bgUrl = urls[type]; } saveData(); applySettings(); renderSettingsGeneral(); }
        function saveBackground() { const url = document.getElementById('bg-url-input').value; if(url) { state.settings.bgUrl = url; saveData(); applySettings(); showToast("Fondo actualizado", "Personalizaci칩n"); renderSettingsGeneral(); } }
        function exportData() { const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state)); a.download = "myday_backup.json"; a.click(); }
        function importData(input) { const f = input.files[0]; if(!f) return; const r = new FileReader(); r.onload = e => { try { state = {...state, ...JSON.parse(e.target.result)}; saveData(); render(); closeSettings(); } catch(e){alert('Error JSON');} }; r.readAsText(f); }
        function resetAllData() { if(confirm("쯉eguro?")) { localStorage.removeItem('myDayOS_v3'); location.reload(); } }

        init();
    </script>
</body>
</html>
