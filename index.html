<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#f2f2f7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>MyDay OS - Google Sync Mobile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        /* Base */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f2f2f7; /* iOS Gray background */
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none; /* Prevenir rebote de p치gina completa */
        }

        /* Desktop Glass Panel (Solo aplica en pantallas grandes) */
        @media (min-width: 1024px) {
            .desktop-glass {
                background: rgba(255, 255, 255, 0.75);
                backdrop-filter: blur(24px);
                -webkit-backdrop-filter: blur(24px);
                border: 1px solid rgba(255, 255, 255, 0.5);
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                border-radius: 24px;
            }
            body {
                padding: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }

        /* Mobile Adjustments */
        @media (max-width: 1023px) {
            body {
                padding: 0;
                background-image: none !important; /* Quitar fondo pesado en m칩vil */
                background-color: #F2F2F7;
            }
            main {
                border-radius: 0 !important;
                border: none !important;
                box-shadow: none !important;
                background: #F2F2F7 !important; /* Color solido app nativa */
            }
        }

        /* Hide Scrollbar but allow scroll */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Custom Checkbox */
        .custom-checkbox input:checked + div {
            background-color: #007AFF;
            border-color: #007AFF;
        }

        /* Animations */
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Mobile View Transitions */
        .view-transition { transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1), opacity 0.3s ease; }
        
        /* Safe Area for iPhones */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }

        /* Bottom Nav Active State */
        .nav-item.active { color: #007AFF; }
        .nav-item.active svg { stroke-width: 2.5px; }

        /* Status de Sincronizaci칩n */
        .sync-badge {
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 99px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            transition: all 0.3s;
            border: 1px solid transparent;
        }
        .sync-active { background-color: #dcfce7; color: #166534; border-color: #bbf7d0; }
        .sync-offline { background-color: #f3f4f6; color: #6b7280; border-color: #e5e7eb; }
        .sync-disabled { background-color: #fee2e2; color: #991b1b; border-color: #fecaca; }
        .sync-connecting { background-color: #fef9c3; color: #854d0e; border-color: #fde047; }
    </style>
</head>
<body class="h-[100dvh] w-screen overflow-hidden text-gray-800" id="app-body">

    <!-- App Container -->
    <main class="w-full h-full lg:max-w-6xl lg:h-[85vh] desktop-glass flex flex-col overflow-hidden relative fade-in">
        
        <!-- HEADER (Adaptativo) -->
        <header class="h-14 lg:h-16 flex items-center justify-between px-4 lg:px-6 bg-white/80 lg:bg-white/40 backdrop-blur-md border-b border-gray-200/50 shrink-0 z-30 pt-safe lg:pt-0">
            <!-- Desktop Traffic Lights -->
            <div class="hidden lg:flex gap-2">
                <div class="w-3 h-3 rounded-full bg-[#FF5F57] border border-[#E0443E]"></div>
                <div class="w-3 h-3 rounded-full bg-[#FEBC2E] border border-[#D89E24]"></div>
                <div class="w-3 h-3 rounded-full bg-[#28C840] border border-[#1AAB29]"></div>
            </div>
            
            <!-- Mobile Title -->
            <div class="lg:hidden font-bold text-lg text-gray-900 flex items-center gap-2">
                <span id="mobile-header-title">Agenda</span>
                <div id="sync-dot" class="w-2 h-2 rounded-full bg-gray-300"></div>
            </div>

            <!-- Desktop Title -->
            <div class="hidden lg:flex items-center gap-2 font-semibold text-gray-600">
                <i data-lucide="layout" class="w-4 h-4"></i> MyDay OS
            </div>

            <!-- Actions -->
            <div class="flex items-center gap-3">
                <div id="sync-status-indicator" class="hidden lg:flex sync-badge sync-offline" title="Estado de Sincronizaci칩n">
                    <div class="w-1.5 h-1.5 rounded-full bg-current"></div>
                    Local
                </div>
                <button onclick="openSettings()" class="p-2 rounded-full hover:bg-gray-200/50 transition-colors">
                    <i data-lucide="settings-2" class="w-6 h-6 lg:w-5 lg:h-5 text-gray-600"></i>
                </button>
                <div id="user-avatar" class="hidden w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-xs ring-2 ring-white shadow-sm overflow-hidden">
                    <img id="user-photo" src="" class="w-full h-full object-cover">
                </div>
            </div>
        </header>

        <!-- CONTENT AREA -->
        <div class="flex-1 relative overflow-hidden flex lg:flex-row bg-[#F2F2F7] lg:bg-transparent">
            
            <!-- VIEW 1: AGENDA (Mobile: View, Desktop: Sidebar) -->
            <section id="view-agenda" class="absolute lg:static inset-0 w-full lg:w-[35%] lg:min-w-[320px] flex flex-col bg-[#F2F2F7] lg:bg-white/40 lg:border-r border-gray-200/50 view-transition z-20">
                
                <!-- Date Selector (Sticky) -->
                <div class="bg-[#F2F2F7]/90 lg:bg-transparent backdrop-blur-sm p-4 pb-2 sticky top-0 z-10">
                    <div class="flex justify-between items-center mb-3 lg:hidden">
                        <h1 class="text-3xl font-bold tracking-tight text-gray-900">Agenda</h1>
                        <button onclick="openModal('schedule')" class="w-8 h-8 bg-blue-500 rounded-full text-white flex items-center justify-center shadow-lg shadow-blue-500/30 active:scale-90 transition">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                        </button>
                    </div>
                    
                    <div class="hidden lg:flex justify-between items-center mb-4 px-2">
                        <h2 class="text-xl font-bold">Calendario</h2>
                        <button onclick="openModal('schedule')" class="text-blue-600 hover:bg-blue-50 p-1 rounded-lg"><i data-lucide="plus" class="w-5 h-5"></i></button>
                    </div>

                    <div class="flex justify-between gap-2 overflow-x-auto no-scrollbar py-1" id="day-selector">
                        <!-- Days injected here -->
                    </div>
                </div>

                <!-- Schedule List -->
                <div class="flex-1 overflow-y-auto px-4 pb-24 lg:pb-4 space-y-3" id="schedule-list">
                    <!-- Events injected here -->
                </div>
            </section>

            <!-- VIEW 2: TASKS (Mobile: View, Desktop: Main) -->
            <section id="view-tasks" class="absolute lg:static inset-0 w-full lg:flex-1 flex flex-col bg-[#F2F2F7] lg:bg-transparent view-transition translate-x-full lg:translate-x-0 z-20">
                
                <div class="flex-1 overflow-y-auto pb-24 lg:pb-0">
                    <!-- Mobile Header for Tasks -->
                    <div class="p-4 lg:p-8">
                        <div class="flex justify-between items-center mb-6 lg:hidden">
                            <h1 class="text-3xl font-bold tracking-tight text-gray-900">Tareas</h1>
                            <button onclick="openModal('todo')" class="w-8 h-8 bg-blue-500 rounded-full text-white flex items-center justify-center shadow-lg shadow-blue-500/30 active:scale-90 transition">
                                <i data-lucide="plus" class="w-5 h-5"></i>
                            </button>
                        </div>

                        <!-- Stats Cards -->
                        <div class="grid grid-cols-2 lg:grid-cols-3 gap-3 lg:gap-5 mb-6">
                            <div class="bg-white p-4 rounded-2xl shadow-sm flex flex-col justify-between h-28 lg:h-32">
                                <div class="flex justify-between"><span class="text-xs font-bold text-gray-400 uppercase">Pendiente</span><i data-lucide="list-todo" class="w-4 h-4 text-orange-500"></i></div>
                                <span class="text-3xl font-bold text-gray-800" id="pending-count">0</span>
                            </div>
                            <div class="bg-white p-4 rounded-2xl shadow-sm flex flex-col justify-between h-28 lg:h-32">
                                <div class="flex justify-between"><span class="text-xs font-bold text-gray-400 uppercase">Hoy</span><i data-lucide="clock" class="w-4 h-4 text-blue-500"></i></div>
                                <span class="text-3xl font-bold text-gray-800" id="today-events-count">0</span>
                            </div>
                            <div class="bg-white p-4 rounded-2xl shadow-sm flex flex-col justify-between h-28 lg:h-32 col-span-2 lg:col-span-1">
                                <div class="flex justify-between"><span class="text-xs font-bold text-gray-400 uppercase">Hecho</span><i data-lucide="check-circle" class="w-4 h-4 text-green-500"></i></div>
                                <span class="text-3xl font-bold text-gray-800" id="completed-count">0</span>
                            </div>
                        </div>

                        <!-- Task List -->
                        <div class="bg-white rounded-2xl shadow-sm overflow-hidden min-h-[300px]">
                            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                                <h3 class="font-bold text-gray-700">Mi Lista</h3>
                                <button onclick="openModal('todo')" class="hidden lg:flex text-xs bg-gray-900 text-white px-3 py-1.5 rounded-lg hover:bg-black transition items-center gap-1">
                                    <i data-lucide="plus" class="w-3 h-3"></i> Nueva
                                </button>
                            </div>
                            <div id="todo-list" class="p-2 space-y-1">
                                <!-- Todos injected here -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </div>

        <!-- MOBILE BOTTOM NAV (iOS Tab Bar) -->
        <nav class="lg:hidden absolute bottom-0 left-0 right-0 h-[83px] bg-white/90 backdrop-blur-xl border-t border-gray-200 flex justify-around items-start pt-2 z-50 pb-safe">
            <button onclick="switchView('agenda')" id="nav-agenda" class="nav-item active flex flex-col items-center w-16 gap-1 text-gray-400 transition-colors">
                <i data-lucide="calendar-days" class="w-6 h-6"></i>
                <span class="text-[10px] font-medium">Agenda</span>
            </button>
            
            <!-- Bot칩n central flotante falso (visual) -->
            <div class="w-12"></div> 
            <button onclick="openModal(currentView === 'agenda' ? 'schedule' : 'todo')" class="absolute top-[-20px] left-1/2 transform -translate-x-1/2 bg-blue-600 text-white w-14 h-14 rounded-full shadow-xl shadow-blue-600/30 flex items-center justify-center active:scale-95 transition">
                <i data-lucide="plus" class="w-7 h-7"></i>
            </button>

            <button onclick="switchView('tasks')" id="nav-tasks" class="nav-item flex flex-col items-center w-16 gap-1 text-gray-400 transition-colors">
                <i data-lucide="check-square" class="w-6 h-6"></i>
                <span class="text-[10px] font-medium">Tareas</span>
            </button>
        </nav>

        <!-- TOASTS -->
        <div id="toast-container" class="absolute top-16 left-4 right-4 z-[60] flex flex-col gap-2 pointer-events-none lg:w-80 lg:right-4 lg:left-auto"></div>

        <!-- MODAL UNIVERSAL (Bottom Sheet on Mobile) -->
        <div id="modal" class="absolute inset-0 z-[100] hidden">
            <div class="absolute inset-0 bg-black/40 backdrop-blur-[2px] transition-opacity opacity-0" id="modal-backdrop" onclick="closeModal()"></div>
            
            <div class="absolute inset-x-0 bottom-0 lg:inset-0 lg:flex lg:items-center lg:justify-center pointer-events-none">
                <div class="bg-white w-full lg:w-[450px] rounded-t-[20px] lg:rounded-2xl shadow-2xl overflow-hidden transform transition-transform duration-300 translate-y-full lg:translate-y-10 lg:scale-95 opacity-0 pointer-events-auto flex flex-col max-h-[90vh]" id="modal-content">
                    
                    <!-- Drag Handle (Mobile) -->
                    <div class="lg:hidden w-full flex justify-center pt-3 pb-1" onclick="closeModal()">
                        <div class="w-10 h-1 bg-gray-300 rounded-full"></div>
                    </div>

                    <div class="p-6 pt-2 lg:pt-6 overflow-y-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-900" id="modal-title">Nuevo</h3>
                            <button onclick="closeModal()" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-200">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <form id="modal-form" onsubmit="handleFormSubmit(event)" class="space-y-4">
                            <div id="form-fields"></div>
                            <div class="pt-4">
                                <button type="submit" class="w-full py-3.5 rounded-xl bg-blue-600 text-white font-bold text-lg lg:text-sm shadow-lg shadow-blue-500/20 active:scale-[0.98] transition">Guardar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- SETTINGS MODAL (Responsive) -->
        <div id="settings-modal" class="absolute inset-0 z-[100] hidden bg-black/40 backdrop-blur-sm flex items-end lg:items-center justify-center">
            <div class="bg-white w-full lg:w-[600px] h-[80vh] lg:h-[500px] rounded-t-[20px] lg:rounded-2xl flex flex-col overflow-hidden animate-slideUp lg:animate-fadeIn">
                <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                    <h3 class="font-bold text-lg">Configuraci칩n</h3>
                    <button onclick="closeSettings()" class="p-2 bg-gray-200 rounded-full"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
                
                <div class="flex flex-1 overflow-hidden">
                    <!-- Sidebar Tabs (Desktop) -->
                    <div class="w-1/3 bg-gray-50 p-2 hidden lg:block border-r">
                        <button onclick="switchSettingsTab('general')" class="settings-tab-btn w-full text-left p-2 rounded-lg hover:bg-white mb-1 text-sm font-medium">General</button>
                        <button onclick="switchSettingsTab('cloud')" class="settings-tab-btn w-full text-left p-2 rounded-lg hover:bg-white mb-1 text-sm font-medium text-blue-600">Nube</button>
                        <button onclick="switchSettingsTab('categories')" class="settings-tab-btn w-full text-left p-2 rounded-lg hover:bg-white mb-1 text-sm font-medium">Categor칤as</button>
                        <button onclick="switchSettingsTab('data')" class="settings-tab-btn w-full text-left p-2 rounded-lg hover:bg-white mb-1 text-sm font-medium">Datos</button>
                    </div>
                    
                    <!-- Mobile Tabs (Top Scroll) -->
                    <div class="lg:hidden w-full overflow-x-auto flex gap-2 p-2 border-b bg-gray-50 shrink-0 no-scrollbar">
                        <button onclick="switchSettingsTab('general')" class="px-4 py-2 bg-white rounded-full text-sm font-bold shadow-sm whitespace-nowrap">General</button>
                        <button onclick="switchSettingsTab('cloud')" class="px-4 py-2 bg-white rounded-full text-sm font-bold shadow-sm text-blue-600 whitespace-nowrap">Nube</button>
                        <button onclick="switchSettingsTab('categories')" class="px-4 py-2 bg-white rounded-full text-sm font-bold shadow-sm whitespace-nowrap">Categor칤as</button>
                    </div>

                    <div class="flex-1 p-6 overflow-y-auto">
                        <!-- GENERAL TAB -->
                        <div id="tab-general" class="settings-content">
                            <h4 class="font-bold mb-4">Fondo</h4>
                            <div class="grid grid-cols-3 gap-2">
                                <div onclick="setPresetBg('nature')" class="aspect-square bg-gray-200 rounded-lg bg-cover" style="background-image: url('https://images.unsplash.com/photo-1472214103451-9374bd1c798e?w=200')"></div>
                                <div onclick="setPresetBg('dark')" class="aspect-square bg-gray-800 rounded-lg bg-cover" style="background-image: url('https://images.unsplash.com/photo-1550684848-fac1c5b4e853?w=200')"></div>
                                <div onclick="setPresetBg('white')" class="aspect-square bg-white border rounded-lg flex items-center justify-center text-xs text-gray-500">Limpiar</div>
                            </div>
                        </div>

                        <!-- CLOUD TAB -->
                        <div id="tab-cloud" class="settings-content hidden">
                            <h4 class="font-bold mb-4">Sincronizaci칩n Google</h4>
                            
                            <div id="auth-ui" class="text-center py-8">
                                <p class="text-sm text-gray-500 mb-4">Inicia sesi칩n para guardar tus datos en la nube y acceder desde cualquier dispositivo.</p>
                                <button onclick="loginWithGoogle()" class="bg-white border text-gray-700 px-6 py-3 rounded-xl shadow-sm flex items-center gap-3 w-full justify-center font-medium hover:bg-gray-50">
                                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5"> Conectar Google
                                </button>
                            </div>

                            <div id="user-ui" class="hidden">
                                <div class="bg-green-50 p-4 rounded-xl border border-green-100 mb-4">
                                    <div class="flex items-center gap-3">
                                        <img id="user-img-settings" src="" class="w-10 h-10 rounded-full border-2 border-white">
                                        <div class="overflow-hidden">
                                            <div id="user-name-settings" class="font-bold text-gray-800 truncate">Usuario</div>
                                            <div class="text-xs text-green-700 font-medium flex items-center gap-1">
                                                <i data-lucide="check-circle-2" class="w-3 h-3"></i> Sincronizaci칩n activa
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button onclick="logout()" class="w-full py-3 text-red-500 font-bold bg-red-50 hover:bg-red-100 rounded-xl transition">Cerrar Sesi칩n</button>
                            </div>
                        </div>

                        <!-- CATEGORIES TAB -->
                        <div id="tab-categories" class="settings-content hidden">
                            <h4 class="font-bold mb-4">Categor칤as</h4>
                            <form onsubmit="handleAddCategory(event)" class="flex gap-2 mb-4">
                                <input type="text" name="catName" placeholder="Nueva..." class="flex-1 px-3 py-2 bg-gray-100 rounded-lg outline-none text-sm" required>
                                <select name="catColor" class="w-12 bg-gray-100 rounded-lg outline-none text-sm p-1">
                                    <option value="blue">游댯</option>
                                    <option value="red">游댮</option>
                                    <option value="green">游릭</option>
                                    <option value="purple">游릮</option>
                                    <option value="orange">游</option>
                                </select>
                                <button type="submit" class="p-2 bg-black text-white rounded-lg"><i data-lucide="plus" class="w-4 h-4"></i></button>
                            </form>
                            <div id="categories-list" class="space-y-2"></div>
                        </div>

                        <!-- DATA TAB -->
                        <div id="tab-data" class="settings-content hidden">
                            <h4 class="font-bold mb-4">Datos</h4>
                            <div class="space-y-3">
                                <button onclick="exportData()" class="w-full flex items-center justify-between p-3 bg-gray-50 rounded-xl hover:bg-gray-100">
                                    <span class="text-sm font-medium">Descargar Backup</span>
                                    <i data-lucide="download" class="w-4 h-4 text-gray-500"></i>
                                </button>
                                <input type="file" id="import-file" class="hidden" onchange="importData(this)">
                                <button onclick="document.getElementById('import-file').click()" class="w-full flex items-center justify-between p-3 bg-gray-50 rounded-xl hover:bg-gray-100">
                                    <span class="text-sm font-medium">Restaurar</span>
                                    <i data-lucide="upload" class="w-4 h-4 text-gray-500"></i>
                                </button>
                                <button onclick="resetAllData()" class="w-full p-3 text-red-500 text-sm font-bold mt-4">Borrar todo</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        // =============================================================================
        //  CONFIGURACI칍N PARA GITHUB PAGES / HOSTING PROPIO
        // =============================================================================
        
        const USER_FIREBASE_CONFIG = {
            apiKey: "AIzaSyDF3lcFQMX9_wvDpoQjWcT0d4aLeK1dwJ0",
            authDomain: "myday-3f736.firebaseapp.com",
            projectId: "myday-3f736",
            storageBucket: "myday-3f736.firebasestorage.app",
            messagingSenderId: "245410649722",
            appId: "1:245410649722:web:fe36ccf0d600e8bbfd0dc3"
        };

        // --- CORE LOGIC ---
        let state = {
            currentDayIndex: new Date().getDay() === 0 ? 6 : new Date().getDay() - 1,
            schedule: [], todos: [],
            categories: [
                {id: 'c1', name: 'Clase', color: 'blue'},
                {id: 'c2', name: 'Tarea', color: 'orange'},
                {id: 'c3', name: 'Ocio', color: 'purple'},
                {id: 'c4', name: 'Urgente', color: 'red'}
            ],
            settings: { bgUrl: 'https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=2564&auto=format&fit=crop' }
        };
        
        let currentView = 'agenda';
        let auth, db, appId, currentUser;
        let isCloudAvailable = false;
        let unsubscribeSnapshot = null;
        let isSaving = false;

        const DAYS_FULL = ['Domingo', 'Lunes', 'Martes', 'Mi칠rcoles', 'Jueves', 'Viernes', 'S치bado'];
        const COLORS = {
            blue: 'bg-blue-100 text-blue-700', red: 'bg-red-100 text-red-700',
            green: 'bg-green-100 text-green-700', purple: 'bg-purple-100 text-purple-700',
            orange: 'bg-orange-100 text-orange-700', pink: 'bg-pink-100 text-pink-700',
            gray: 'bg-gray-100 text-gray-700', yellow: 'bg-yellow-100 text-yellow-800'
        };

        // --- INIT ---
        try {
            firebase.initializeApp(USER_FIREBASE_CONFIG);
            auth = firebase.auth();
            db = firebase.firestore();
            appId = USER_FIREBASE_CONFIG.projectId;
            isCloudAvailable = true;
        } catch(e) { console.log("Offline mode", e); }

        function init() {
            // Cargar datos locales primero
            const local = localStorage.getItem('myDayOS_v3');
            if(local) state = {...state, ...JSON.parse(local)};
            
            render();
            setupAuthListener();
            
            setInterval(updateClock, 1000);
            updateClock();
        }

        // --- AUTH & SYNC ---
        function setupAuthListener() {
            if(!isCloudAvailable) return;
            
            auth.onAuthStateChanged(user => {
                currentUser = user;
                const authUi = document.getElementById('auth-ui');
                const userUi = document.getElementById('user-ui');
                const avatar = document.getElementById('user-avatar');
                const statusIndicator = document.getElementById('sync-status-indicator');
                const syncDot = document.getElementById('sync-dot');

                if(user) {
                    // UI Logueado
                    authUi.classList.add('hidden');
                    userUi.classList.remove('hidden');
                    avatar.classList.remove('hidden');
                    document.getElementById('user-photo').src = user.photoURL;
                    
                    // Info en Settings
                    document.getElementById('user-img-settings').src = user.photoURL;
                    document.getElementById('user-name-settings').innerText = user.displayName;

                    // Indicators
                    if(statusIndicator) {
                        statusIndicator.className = 'sync-badge sync-active hidden lg:flex';
                        statusIndicator.innerHTML = '<div class="w-1.5 h-1.5 rounded-full bg-current"></div> Nube';
                    }
                    if(syncDot) {
                        syncDot.classList.remove('bg-gray-300'); syncDot.classList.add('bg-green-500');
                    }
                    
                    activateFirestoreSync(user.uid);
                } else {
                    // UI Deslogueado
                    authUi.classList.remove('hidden');
                    userUi.classList.add('hidden');
                    avatar.classList.add('hidden');
                    if(syncDot) { syncDot.classList.add('bg-gray-300'); syncDot.classList.remove('bg-green-500'); }
                    if(statusIndicator) {
                        statusIndicator.className = 'sync-badge sync-offline hidden lg:flex';
                        statusIndicator.innerHTML = '<div class="w-1.5 h-1.5 rounded-full bg-current"></div> Local';
                    }
                    if(unsubscribeSnapshot) unsubscribeSnapshot();
                }
            });
        }

        function activateFirestoreSync(uid) {
            if (!isCloudAvailable) return;
            if(unsubscribeSnapshot) unsubscribeSnapshot();

            // Ruta: /artifacts/{appId}/users/{uid}/data/main
            const docRef = db.collection('artifacts').doc(appId).collection('users').doc(uid).collection('data').doc('main');

            let firstLoad = true;

            unsubscribeSnapshot = docRef.onSnapshot((doc) => {
                if(doc.exists && !isSaving) {
                    const remoteData = doc.data();
                    state.schedule = remoteData.schedule || [];
                    state.todos = remoteData.todos || [];
                    state.categories = remoteData.categories || state.categories;
                    
                    render(); // Re-renderizar todo
                    
                    if(!firstLoad) showToast('Sincronizado', 'Nube');
                } else if (!doc.exists && (state.schedule.length > 0 || state.todos.length > 0)) {
                    saveDataToCloud(); // Subir lo local si es nuevo usuario
                }
                firstLoad = false;
            });
        }

        function loginWithGoogle() { 
            const p = new firebase.auth.GoogleAuthProvider(); 
            auth.signInWithPopup(p).catch(e => alert("Error auth: " + e.message)); 
        }
        function logout() { auth.signOut(); }

        // --- DATA PERSISTENCE ---
        async function saveData() {
            localStorage.setItem('myDayOS_v3', JSON.stringify(state));
            renderStats(); // Actualizar stats r치pido
            if(isCloudAvailable && currentUser) {
                saveDataToCloud();
            }
        }

        let saveTimeout;
        function saveDataToCloud() {
            if (!isCloudAvailable || !currentUser) return;
            clearTimeout(saveTimeout);
            isSaving = true;
            saveTimeout = setTimeout(async () => {
                try {
                    const docRef = db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid).collection('data').doc('main');
                    await docRef.set({
                        schedule: state.schedule,
                        todos: state.todos,
                        categories: state.categories,
                        lastUpdated: new Date()
                    });
                } catch(e) { console.error(e); }
                isSaving = false;
            }, 1000);
        }

        // --- RENDER ---
        function render() {
            renderDays();
            renderSchedule();
            renderTodos();
            renderStats();
            applySettings();
            lucide.createIcons();
        }

        function switchView(view) {
            currentView = view;
            const agenda = document.getElementById('view-agenda');
            const tasks = document.getElementById('view-tasks');
            const navA = document.getElementById('nav-agenda');
            const navT = document.getElementById('nav-tasks');
            const title = document.getElementById('mobile-header-title');

            if (view === 'agenda') {
                tasks.classList.add('translate-x-full');
                agenda.classList.remove('-translate-x-full');
                navA.classList.add('active'); navT.classList.remove('active');
                title.textContent = 'Agenda';
            } else {
                tasks.classList.remove('translate-x-full');
                agenda.classList.add('-translate-x-full');
                navT.classList.add('active'); navA.classList.remove('active');
                title.textContent = 'Tareas';
            }
        }

        function renderDays() {
            const now = new Date();
            const currentDayNum = now.getDay(); 
            const diff = now.getDate() - currentDayNum + (currentDayNum === 0 ? -6 : 1);
            const monday = new Date(now.setDate(diff));
            
            let html = '';
            for(let i=0; i<7; i++) {
                let d = new Date(monday);
                d.setDate(monday.getDate() + i);
                const isSel = i === state.currentDayIndex;
                const isToday = new Date().toDateString() === d.toDateString();
                const dayNameShort = DAYS_FULL[d.getDay() === 0 ? 0 : d.getDay()].substring(0,3);

                html += `
                <button onclick="setDay(${i})" class="flex flex-col items-center justify-center min-w-[3.5rem] h-14 rounded-xl transition-all ${isSel ? 'bg-white shadow-md text-blue-600 scale-105' : 'bg-transparent text-gray-400'}">
                    <span class="text-[10px] font-bold uppercase">${dayNameShort}</span>
                    <span class="text-lg font-bold ${isToday && !isSel ? 'text-blue-500' : ''}">${d.getDate()}</span>
                    ${isToday ? '<span class="w-1 h-1 bg-blue-500 rounded-full mt-1"></span>' : ''}
                </button>`;
            }
            document.getElementById('day-selector').innerHTML = html;
        }

        function renderSchedule() {
            const list = document.getElementById('schedule-list');
            // Calcular fecha seleccionada
            const now = new Date();
            const currentDayNum = now.getDay();
            const diff = now.getDate() - currentDayNum + (currentDayNum === 0 ? -6 : 1);
            const monday = new Date(now.setDate(diff));
            const selectedDate = new Date(monday);
            selectedDate.setDate(monday.getDate() + state.currentDayIndex);
            
            // Usar el nombre completo del d칤a para filtrar (compatible con datos anteriores)
            const dayName = DAYS_FULL[selectedDate.getDay() === 0 ? 0 : selectedDate.getDay()];
            
            const items = state.schedule.filter(s => s.day === dayName).sort((a,b)=>a.time.localeCompare(b.time));
            
            if(items.length === 0) {
                list.innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-gray-400">
                    <i data-lucide="coffee" class="w-12 h-12 mb-2 opacity-50"></i>
                    <p class="text-sm">Nada para el ${dayName}</p>
                </div>`;
                return;
            }

            list.innerHTML = items.map(item => {
                const cat = state.categories.find(c=>c.id===item.categoryId) || {color:'gray', name:''};
                const colorMap = {blue:'bg-blue-500', orange:'bg-orange-500', purple:'bg-purple-500', red:'bg-red-500', green:'bg-green-500'};
                
                return `
                <div class="bg-white p-4 rounded-2xl shadow-sm flex gap-4 active:scale-[0.98] transition-transform" onclick="openModal('schedule', '${item.id}')">
                    <div class="flex flex-col items-center w-12 border-r border-gray-100 pr-2 pt-1">
                        <span class="font-bold text-gray-700 text-sm">${item.time}</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="w-2 h-2 rounded-full ${colorMap[cat.color] || 'bg-gray-400'}"></span>
                            <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">${cat.name}</span>
                        </div>
                        <h3 class="font-bold text-gray-800 truncate text-lg">${item.title}</h3>
                        ${item.desc ? `<p class="text-sm text-gray-500 truncate">${item.desc}</p>` : ''}
                    </div>
                </div>`;
            }).join('');
        }

        function renderTodos() {
            const list = document.getElementById('todo-list');
            const items = state.todos.sort((a,b) => a.completed - b.completed);
            
            if(items.length === 0) {
                list.innerHTML = '<div class="p-8 text-center text-gray-400 text-sm">Sin tareas pendientes</div>';
                return;
            }

            list.innerHTML = items.map(item => {
                const cat = state.categories.find(c=>c.id===item.categoryId) || {color:'gray', name:''};
                const bgClass = COLORS[cat.color] || 'bg-gray-100 text-gray-500';
                
                return `
                <div class="flex items-center gap-3 p-3 bg-white rounded-xl active:bg-gray-50 transition border-b border-gray-50 last:border-0">
                    <label class="custom-checkbox relative flex items-center justify-center w-6 h-6">
                        <input type="checkbox" class="sr-only" ${item.completed?'checked':''} onchange="toggleTodo('${item.id}')">
                        <div class="w-5 h-5 border-2 border-gray-300 rounded-md transition-colors flex items-center justify-center">
                            <i data-lucide="check" class="w-3.5 h-3.5 text-white"></i>
                        </div>
                    </label>
                    <div class="flex-1 min-w-0" onclick="openModal('todo', '${item.id}')">
                        <p class="font-medium text-gray-800 ${item.completed?'line-through text-gray-400':''} truncate text-base">${item.text}</p>
                        <span class="text-[10px] font-bold px-1.5 py-0.5 rounded ${bgClass}">${cat.name}</span>
                    </div>
                    <button onclick="deleteItem('todo','${item.id}')" class="text-gray-300 p-2"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>`;
            }).join('');
        }

        function renderStats() {
            document.getElementById('pending-count').innerText = state.todos.filter(t=>!t.completed).length;
            document.getElementById('completed-count').innerText = state.todos.filter(t=>t.completed).length;
            const today = DAYS_FULL[new Date().getDay() === 0 ? 0 : new Date().getDay()];
            document.getElementById('today-events-count').innerText = state.schedule.filter(s=>s.day===today).length;
        }

        function renderCategoriesList() {
            document.getElementById('categories-list').innerHTML = state.categories.map(c => `
                <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full bg-${c.color}-500"></div>
                        <span class="text-sm font-medium">${c.name}</span>
                    </div>
                    <button onclick="deleteCategory('${c.id}')" class="text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // --- ACTIONS ---
        function setDay(i) { state.currentDayIndex = i; render(); }
        
        function toggleTodo(id) {
            const t = state.todos.find(x=>x.id===id);
            if(t) { t.completed = !t.completed; saveData(); render(); }
        }
        
        function deleteItem(type, id) {
            if(!confirm('쮼liminar?')) return;
            if(type==='schedule') state.schedule = state.schedule.filter(x=>x.id!==id);
            else state.todos = state.todos.filter(x=>x.id!==id);
            saveData(); render();
        }

        function handleAddCategory(e) { 
            e.preventDefault(); const fd = new FormData(e.target); 
            state.categories.push({id:'c'+Date.now(), name:fd.get('catName'), color:fd.get('catColor')}); 
            saveData(); renderCategoriesList(); e.target.reset(); 
        }
        function deleteCategory(id) { 
            if(state.categories.length>1 && confirm('쮹orrar?')) { 
                state.categories = state.categories.filter(c=>c.id!==id); saveData(); renderCategoriesList(); 
            } 
        }

        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            const dateFull = now.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('live-clock').textContent = timeStr;
            document.getElementById('live-date-full').textContent = dateFull;
        }

        // --- MODALS & UI ---
        let modalConfig = {};
        function openModal(type, id=null) {
            modalConfig = {type, id};
            const modal = document.getElementById('modal');
            const content = document.getElementById('modal-content');
            const backdrop = document.getElementById('modal-backdrop');
            const fields = document.getElementById('form-fields');
            
            let data = id ? (type==='schedule'?state.schedule.find(x=>x.id===id):state.todos.find(x=>x.id===id)) : null;
            document.getElementById('modal-title').innerText = id ? 'Editar' : (type==='schedule'?'Nuevo Evento':'Nueva Tarea');
            
            const cats = state.categories.map(c=>`<option value="${c.id}" ${data&&data.categoryId===c.id?'selected':''}>${c.name}</option>`).join('');
            const days = DAYS_FULL.map(d=>`<option value="${d}" ${data&&data.day===d?'selected':''}>${d}</option>`).join('');
            
            const inputClass = "w-full bg-gray-100 rounded-xl px-4 py-3 text-base outline-none focus:ring-2 focus:ring-blue-500 border-none transition-colors";

            if(type==='schedule') {
                fields.innerHTML = `
                    <input name="title" class="${inputClass} font-bold text-lg bg-white border border-gray-200" placeholder="T칤tulo del evento" value="${data?data.title:''}" required>
                    <div class="grid grid-cols-2 gap-3">
                        <select name="day" class="${inputClass}">${days}</select>
                        <input type="time" name="time" class="${inputClass}" value="${data?data.time:'09:00'}" required>
                    </div>
                    <select name="categoryId" class="${inputClass}">${cats}</select>
                    <textarea name="desc" class="${inputClass} h-24 resize-none" placeholder="Notas...">${data?data.desc||'':''}</textarea>
                `;
            } else {
                fields.innerHTML = `
                    <input name="text" class="${inputClass} font-bold text-lg bg-white border border-gray-200" placeholder="쯈u칠 hay que hacer?" value="${data?data.text:''}" required autoFocus>
                    <select name="categoryId" class="${inputClass} mt-2">${cats}</select>
                `;
            }

            modal.classList.remove('hidden');
            setTimeout(()=>{
                backdrop.classList.remove('opacity-0');
                content.classList.remove('translate-y-full', 'opacity-0', 'lg:scale-95');
                content.classList.add('lg:scale-100');
            },10);
        }

        function closeModal() {
            const modal = document.getElementById('modal');
            const content = document.getElementById('modal-content');
            const backdrop = document.getElementById('modal-backdrop');
            content.classList.add('translate-y-full', 'opacity-0', 'lg:scale-95');
            content.classList.remove('lg:scale-100');
            backdrop.classList.add('opacity-0');
            setTimeout(()=>modal.classList.add('hidden'), 300);
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            const fd = new FormData(e.target);
            const {type, id} = modalConfig;
            
            if(type==='schedule') {
                const item = {id: id||Date.now().toString(), title: fd.get('title'), day: fd.get('day'), time: fd.get('time'), categoryId: fd.get('categoryId'), desc: fd.get('desc')};
                if(id) { const idx = state.schedule.findIndex(x=>x.id===id); state.schedule[idx]=item; }
                else state.schedule.push(item);
            } else {
                const item = {id: id||Date.now().toString(), text: fd.get('text'), categoryId: fd.get('categoryId'), completed: id?state.todos.find(x=>x.id===id).completed:false};
                if(id) { const idx = state.todos.findIndex(x=>x.id===id); state.todos[idx]=item; }
                else state.todos.push(item);
            }
            saveData(); closeModal(); render();
        }

        function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); renderCategoriesList(); }
        function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }
        
        function switchSettingsTab(tab) {
            document.querySelectorAll('.settings-content').forEach(x=>x.classList.add('hidden'));
            document.getElementById('tab-'+tab).classList.remove('hidden');
        }
        
        function setPresetBg(type) {
            if(type==='white') state.settings.bgUrl = '';
            else {
                const urls = {nature:'https://images.unsplash.com/photo-1472214103451-9374bd1c798e?w=1200', dark:'https://images.unsplash.com/photo-1550684848-fac1c5b4e853?w=1200'};
                state.settings.bgUrl = urls[type];
            }
            saveData(); applySettings();
        }
        function applySettings() {
            if(state.settings.bgUrl) document.body.style.backgroundImage = `url('${state.settings.bgUrl}')`;
            else document.body.style.backgroundImage = 'none';
        }

        function showToast(msg, title) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast-notification bg-white/90 backdrop-blur-md p-3 rounded-xl shadow-lg border border-white/50 flex gap-3 animate-slideUp';
            toast.innerHTML = `<div class="bg-blue-100 p-2 rounded-full text-blue-600"><i data-lucide="bell" class="w-4 h-4"></i></div><div><h4 class="font-bold text-sm">${title}</h4><p class="text-xs text-gray-500">${msg}</p></div>`;
            container.appendChild(toast);
            lucide.createIcons();
            setTimeout(()=>toast.remove(), 4000);
        }

        // Data helpers
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
            const a = document.createElement('a'); a.href = dataStr; a.download = "myday_backup.json"; a.click();
        }
        function importData(input) {
            const file = input.files[0]; if(!file) return;
            const r = new FileReader();
            r.onload = e => { try { state = {...state, ...JSON.parse(e.target.result)}; saveData(); render(); closeSettings(); } catch(e){alert('Error JSON');} };
            r.readAsText(file);
        }
        function resetAllData() { if(confirm('쮹orrar todo?')) { localStorage.removeItem('myDayOS_v3'); location.reload(); } }

        init();
    </script>
</body>
</html>
