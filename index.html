<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyDay OS 3.0 - Cloud Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <style>
        /* Tipografía estilo Apple */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            transition: background-image 0.5s ease-in-out;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
        }

        /* Variables CSS para temas dinámicos */
        :root {
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.5);
            --sidebar-bg: rgba(245, 245, 247, 0.6);
            --text-main: #1f2937;
            --text-muted: #6b7280;
        }

        /* Efecto Glassmorphism Profundo */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .glass-sidebar {
            background: var(--sidebar-bg);
            backdrop-filter: blur(30px);
            border-right: 1px solid rgba(0, 0, 0, 0.05);
        }

        /* Toast de Notificación estilo macOS */
        .toast-notification {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border-radius: 14px;
            animation: slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        @keyframes slideInRight {
            from { transform: translateX(120%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutRight {
            to { transform: translateX(120%); opacity: 0; }
        }

        /* Scrollbar refinado */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(0, 0, 0, 0.15); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(0, 0, 0, 0.25); }

        /* Checkbox animado */
        .custom-checkbox input:checked + div {
            background-color: #007AFF;
            border-color: #007AFF;
            transform: scale(1.05);
        }
        
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        /* Status de Sincronización */
        .sync-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 99px;
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .sync-active { background-color: #dcfce7; color: #166534; }
        .sync-offline { background-color: #f3f4f6; color: #6b7280; }
        .sync-disabled { background-color: #fee2e2; color: #991b1b; }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden flex items-center justify-center p-4 selection:bg-blue-500 selection:text-white" id="app-body">

    <!-- Contenedor Principal -->
    <main class="w-full max-w-7xl h-[92vh] glass-panel rounded-2xl flex flex-col overflow-hidden relative fade-in">
        
        <!-- Header -->
        <header class="h-14 flex items-center justify-between px-5 border-b border-gray-200/30 bg-white/40 shrink-0 select-none">
            <div class="flex gap-2">
                <div class="w-3.5 h-3.5 rounded-full bg-[#FF5F57] border border-[#E0443E] hover:bg-[#FF5F57]/80 cursor-pointer shadow-sm"></div>
                <div class="w-3.5 h-3.5 rounded-full bg-[#FEBC2E] border border-[#D89E24] hover:bg-[#FEBC2E]/80 cursor-pointer shadow-sm"></div>
                <div class="w-3.5 h-3.5 rounded-full bg-[#28C840] border border-[#1AAB29] hover:bg-[#28C840]/80 cursor-pointer shadow-sm"></div>
            </div>
            
            <div class="text-sm font-semibold text-gray-600/90 tracking-tight flex items-center gap-2">
                <i data-lucide="command" class="w-4 h-4"></i>
                MyDay OS <span class="text-xs opacity-50 font-normal">Cloud Edition</span>
            </div>

            <div class="flex items-center gap-4">
                <div id="sync-status-indicator" class="sync-badge sync-offline" title="Estado de Sincronización">
                    <div class="w-1.5 h-1.5 rounded-full bg-current"></div>
                    Local
                </div>
                <button onclick="openSettings()" class="text-gray-500 hover:text-gray-800 transition-colors p-1 rounded-md hover:bg-white/50" title="Configuración">
                    <i data-lucide="settings-2" class="w-4 h-4"></i>
                </button>
                <div class="text-right hidden sm:block">
                    <div id="live-clock" class="text-sm font-medium text-gray-700 tabular-nums leading-none">--:--</div>
                    <div id="live-date-full" class="text-[10px] font-medium text-gray-400 uppercase tracking-wider leading-none mt-1">Cargando...</div>
                </div>
            </div>
        </header>

        <!-- Cuerpo de la App -->
        <div class="flex flex-1 overflow-hidden">
            
            <!-- Panel Izquierdo: Agenda / Horario -->
            <section class="w-[35%] glass-sidebar flex flex-col min-w-[320px] max-w-md relative z-10">
                <div class="p-5 pb-2 border-b border-gray-200/50">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2 tracking-tight">
                            <i data-lucide="calendar" class="w-5 h-5 text-blue-500"></i>
                            Agenda
                        </h2>
                        <button onclick="openModal('schedule')" class="w-8 h-8 rounded-full bg-white shadow-sm hover:shadow text-blue-600 flex items-center justify-center transition-all hover:scale-105 active:scale-95" title="Añadir Evento">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                        </button>
                    </div>

                    <!-- Selector de Días Semanal (Real Dates) -->
                    <div class="flex justify-between bg-gray-200/50 p-1 rounded-lg mb-2 overflow-x-auto no-scrollbar">
                        <div id="day-selector" class="flex w-full justify-between gap-1"></div>
                    </div>
                </div>
                
                <div class="flex-1 overflow-y-auto p-4 space-y-3" id="schedule-list">
                    <!-- Eventos renderizados aquí -->
                </div>
                
                <!-- Footer del panel izquierdo -->
                <div class="p-3 border-t border-gray-200/50 bg-white/30 text-xs text-center text-gray-500 font-medium flex justify-between px-6">
                    <span id="schedule-summary">0 eventos</span>
                    <span class="text-blue-500 cursor-pointer hover:underline" onclick="setDay(new Date().getDay() === 0 ? 6 : new Date().getDay() - 1)">Ir a Hoy</span>
                </div>
            </section>

            <!-- Panel Derecho: Dashboard y Tareas -->
            <section class="flex-1 bg-white/30 flex flex-col relative">
                
                <!-- Dashboard de Métricas -->
                <div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-5">
                    <!-- Tarjeta Pendientes -->
                    <div class="bg-white/70 backdrop-blur-md p-5 rounded-2xl shadow-sm border border-white/50 flex flex-col justify-between h-28 group hover:scale-[1.02] transition-transform duration-300">
                        <div class="flex justify-between items-start">
                            <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Por Hacer</span>
                            <div class="bg-orange-100 p-2 rounded-lg text-orange-500 group-hover:bg-orange-500 group-hover:text-white transition-colors">
                                <i data-lucide="list-todo" class="w-5 h-5"></i>
                            </div>
                        </div>
                        <div>
                            <span class="text-3xl font-bold text-gray-800" id="pending-count">0</span>
                            <span class="text-xs text-gray-400 ml-1">tareas</span>
                        </div>
                    </div>

                    <!-- Tarjeta Eventos Hoy -->
                    <div class="bg-white/70 backdrop-blur-md p-5 rounded-2xl shadow-sm border border-white/50 flex flex-col justify-between h-28 group hover:scale-[1.02] transition-transform duration-300">
                        <div class="flex justify-between items-start">
                            <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Hoy</span>
                            <div class="bg-blue-100 p-2 rounded-lg text-blue-500 group-hover:bg-blue-500 group-hover:text-white transition-colors">
                                <i data-lucide="clock" class="w-5 h-5"></i>
                            </div>
                        </div>
                        <div>
                            <span class="text-3xl font-bold text-gray-800" id="today-events-count">0</span>
                            <span class="text-xs text-gray-400 ml-1">eventos</span>
                        </div>
                    </div>

                    <!-- Tarjeta Completados -->
                    <div class="bg-white/70 backdrop-blur-md p-5 rounded-2xl shadow-sm border border-white/50 flex flex-col justify-between h-28 group hover:scale-[1.02] transition-transform duration-300">
                        <div class="flex justify-between items-start">
                            <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Historial</span>
                            <div class="bg-green-100 p-2 rounded-lg text-green-500 group-hover:bg-green-500 group-hover:text-white transition-colors">
                                <i data-lucide="check-circle" class="w-5 h-5"></i>
                            </div>
                        </div>
                        <div>
                            <span class="text-3xl font-bold text-gray-800" id="completed-count">0</span>
                            <span class="text-xs text-gray-400 ml-1">total</span>
                        </div>
                    </div>
                </div>

                <!-- Lista de Tareas Principal -->
                <div class="flex-1 mx-4 mb-4 bg-white/50 backdrop-blur-xl rounded-2xl shadow-[0_8px_30px_rgba(0,0,0,0.04)] border border-white/60 flex flex-col overflow-hidden">
                    <div class="p-5 flex justify-between items-center border-b border-gray-100 bg-white/40 sticky top-0 z-10">
                        <div class="flex items-center gap-2">
                            <h3 class="text-lg font-bold text-gray-700">Mis Tareas</h3>
                            <span class="bg-gray-200 text-gray-600 text-[10px] px-2 py-0.5 rounded-full font-bold" id="total-todos-badge">0</span>
                        </div>
                        <div class="flex gap-2">
                             <button onclick="openModal('todo')" class="text-sm font-medium px-4 py-2 rounded-lg bg-gray-900 text-white shadow-lg hover:bg-black transition-all flex items-center gap-2 active:scale-95">
                                <i data-lucide="plus-circle" class="w-4 h-4"></i> Nueva
                             </button>
                        </div>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto p-2" id="todo-list">
                        <!-- Las tareas se renderizan aquí -->
                    </div>
                </div>
            </section>
        </div>

        <!-- Contenedor de Notificaciones (Toasts) -->
        <div id="toast-container" class="absolute top-16 right-5 z-[60] flex flex-col gap-3 pointer-events-none w-80">
            <!-- Los toasts se inyectan aquí -->
        </div>

        <!-- MODAL UNIVERSAL (Agregar/Editar) -->
        <div id="modal" class="absolute inset-0 z-50 hidden">
            <div class="absolute inset-0 bg-gray-900/20 backdrop-blur-sm transition-opacity opacity-0" id="modal-backdrop" onclick="closeModal()"></div>
            <div class="absolute inset-0 flex items-center justify-center p-4 pointer-events-none">
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden transform scale-95 opacity-0 transition-all duration-300 pointer-events-auto border border-gray-100" id="modal-content">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h3 class="text-xl font-bold text-gray-900" id="modal-title">Título</h3>
                                <p class="text-sm text-gray-500" id="modal-subtitle">Subtítulo</p>
                            </div>
                            <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-500 transition-colors">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        </div>
                        
                        <form id="modal-form" onsubmit="handleFormSubmit(event)" class="space-y-5">
                            <div id="form-fields"></div>
                            
                            <div class="flex justify-end gap-3 pt-4 border-t border-gray-100 mt-6">
                                <button type="button" onclick="closeModal()" class="px-5 py-2.5 rounded-xl text-gray-600 hover:bg-gray-50 font-medium transition text-sm">Cancelar</button>
                                <button type="submit" class="px-6 py-2.5 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-medium shadow-lg shadow-blue-500/20 transition transform active:scale-95 text-sm flex items-center gap-2">
                                    <i data-lucide="save" class="w-4 h-4"></i> Guardar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL DE AJUSTES AVANZADOS -->
        <div id="settings-modal" class="absolute inset-0 z-50 hidden flex items-center justify-center bg-black/20 backdrop-blur-sm p-4">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl h-[500px] flex overflow-hidden animate-[fadeIn_0.2s_ease-out]">
                <!-- Sidebar Ajustes -->
                <div class="w-1/3 bg-gray-50 border-r p-4 flex flex-col gap-2">
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-2 px-2">Ajustes</h3>
                    <button onclick="switchSettingsTab('general')" class="settings-tab-btn active text-left px-3 py-2 rounded-lg text-sm font-medium text-gray-700 hover:bg-white hover:shadow-sm transition" data-tab="general">
                        <i data-lucide="layout" class="w-4 h-4 inline mr-2"></i> General
                    </button>
                    <button onclick="switchSettingsTab('cloud')" class="settings-tab-btn text-left px-3 py-2 rounded-lg text-sm font-medium text-gray-700 hover:bg-white hover:shadow-sm transition text-blue-600" data-tab="cloud">
                        <i data-lucide="cloud" class="w-4 h-4 inline mr-2"></i> Nube / Sync
                    </button>
                    <button onclick="switchSettingsTab('categories')" class="settings-tab-btn text-left px-3 py-2 rounded-lg text-sm font-medium text-gray-700 hover:bg-white hover:shadow-sm transition" data-tab="categories">
                        <i data-lucide="tags" class="w-4 h-4 inline mr-2"></i> Categorías
                    </button>
                    <button onclick="switchSettingsTab('data')" class="settings-tab-btn text-left px-3 py-2 rounded-lg text-sm font-medium text-gray-700 hover:bg-white hover:shadow-sm transition" data-tab="data">
                        <i data-lucide="database" class="w-4 h-4 inline mr-2"></i> Datos
                    </button>
                    <button onclick="switchSettingsTab('system')" class="settings-tab-btn text-left px-3 py-2 rounded-lg text-sm font-medium text-gray-700 hover:bg-white hover:shadow-sm transition" data-tab="system">
                        <i data-lucide="bell" class="w-4 h-4 inline mr-2"></i> Sistema
                    </button>
                </div>

                <!-- Contenido Ajustes -->
                <div class="flex-1 p-8 overflow-y-auto relative">
                    <button onclick="closeSettings()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button>
                    
                    <!-- TAB: General -->
                    <div id="tab-general" class="settings-content block">
                        <h2 class="text-xl font-bold mb-4">Personalización</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fondo de Pantalla (URL)</label>
                                <div class="flex gap-2">
                                    <input type="text" id="bg-url-input" class="flex-1 border rounded-lg px-3 py-2 text-sm" placeholder="https://...">
                                    <button onclick="saveBackground()" class="bg-blue-600 text-white px-3 py-2 rounded-lg text-sm">Aplicar</button>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">Usa imágenes de Unsplash para mejor calidad.</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Preestablecidos</label>
                                <div class="flex gap-2">
                                    <button onclick="setPresetBg('nature')" class="w-10 h-10 rounded-full bg-cover bg-center border-2 border-transparent hover:border-blue-500" style="background-image: url('https://images.unsplash.com/photo-1472214103451-9374bd1c798e?q=80&w=2070&auto=format&fit=crop')"></button>
                                    <button onclick="setPresetBg('dark')" class="w-10 h-10 rounded-full bg-cover bg-center border-2 border-transparent hover:border-blue-500" style="background-image: url('https://images.unsplash.com/photo-1550684848-fac1c5b4e853?q=80&w=2070&auto=format&fit=crop')"></button>
                                    <button onclick="setPresetBg('abstract')" class="w-10 h-10 rounded-full bg-cover bg-center border-2 border-transparent hover:border-blue-500" style="background-image: url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=2564&auto=format&fit=crop')"></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TAB: Cloud / Sync -->
                    <div id="tab-cloud" class="settings-content hidden">
                        <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                            <i data-lucide="cloud" class="w-5 h-5 text-blue-600"></i> Sincronización
                        </h2>
                        <div class="space-y-4">
                            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                <p class="text-sm text-blue-800 mb-2">
                                    Para sincronizar tus datos entre dispositivos (PC, Celular), ingresa una <strong>Clave Secreta</strong>. Usa la misma clave en todos tus dispositivos.
                                </p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-1">ID / Clave de Sincronización</label>
                                <div class="flex gap-2">
                                    <input type="text" id="sync-id-input" class="flex-1 border rounded-lg px-3 py-2 text-sm font-mono tracking-wider" placeholder="ej: mi-agenda-secreta-2024">
                                    <button onclick="connectSync()" class="bg-gray-900 text-white px-4 py-2 rounded-lg text-sm hover:bg-black transition shadow-lg">Conectar</button>
                                </div>
                                <p class="text-xs text-gray-400 mt-2">Nota: Cualquiera con esta clave puede ver tus datos. Usa algo único y complejo.</p>
                            </div>

                            <div id="sync-active-message" class="hidden p-3 bg-green-50 text-green-700 rounded-lg text-sm border border-green-100 flex items-center gap-2">
                                <i data-lucide="check-circle-2" class="w-4 h-4"></i> Conectado a la nube.
                            </div>
                            <div id="sync-error-message" class="hidden p-3 bg-red-50 text-red-700 rounded-lg text-sm border border-red-100 flex items-center gap-2">
                                <i data-lucide="alert-triangle" class="w-4 h-4"></i> Nube no disponible (Modo Local).
                            </div>
                        </div>
                    </div>

                    <!-- TAB: Categorías -->
                    <div id="tab-categories" class="settings-content hidden">
                        <h2 class="text-xl font-bold mb-4">Categorías</h2>
                        <form onsubmit="handleAddCategory(event)" class="flex gap-2 mb-4">
                            <input type="text" name="catName" placeholder="Nueva Categoría" class="flex-1 px-3 py-2 bg-gray-50 rounded-lg border outline-none text-sm" required>
                            <select name="catColor" class="px-3 py-2 bg-gray-50 rounded-lg border outline-none text-sm">
                                <option value="blue">Azul</option>
                                <option value="red">Rojo</option>
                                <option value="green">Verde</option>
                                <option value="purple">Morado</option>
                                <option value="orange">Naranja</option>
                                <option value="pink">Rosa</option>
                                <option value="gray">Gris</option>
                                <option value="yellow">Amarillo</option>
                            </select>
                            <button type="submit" class="p-2 bg-gray-900 text-white rounded-lg hover:bg-black"><i data-lucide="plus" class="w-4 h-4"></i></button>
                        </form>
                        <div id="categories-list" class="space-y-2 max-h-60 overflow-y-auto pr-2"></div>
                    </div>

                    <!-- TAB: Datos -->
                    <div id="tab-data" class="settings-content hidden">
                        <h2 class="text-xl font-bold mb-4">Gestión de Datos</h2>
                        <div class="space-y-4">
                            <div class="p-4 bg-gray-50 rounded-xl border">
                                <h4 class="font-bold text-sm mb-1">Copia de Seguridad</h4>
                                <p class="text-xs text-gray-500 mb-3">Descarga todos tus horarios y tareas en un archivo JSON.</p>
                                <button onclick="exportData()" class="flex items-center gap-2 px-4 py-2 bg-white border shadow-sm rounded-lg text-sm hover:bg-gray-50">
                                    <i data-lucide="download" class="w-4 h-4"></i> Descargar Backup
                                </button>
                            </div>
                            <div class="p-4 bg-gray-50 rounded-xl border">
                                <h4 class="font-bold text-sm mb-1">Restaurar</h4>
                                <p class="text-xs text-gray-500 mb-3">Sube un archivo JSON para recuperar tus datos.</p>
                                <input type="file" id="import-file" class="hidden" onchange="importData(this)">
                                <button onclick="document.getElementById('import-file').click()" class="flex items-center gap-2 px-4 py-2 bg-white border shadow-sm rounded-lg text-sm hover:bg-gray-50">
                                    <i data-lucide="upload" class="w-4 h-4"></i> Seleccionar Archivo
                                </button>
                            </div>
                            <div class="pt-4 border-t">
                                <button onclick="resetAllData()" class="text-red-500 text-sm font-medium hover:underline">Borrar todos los datos de fábrica</button>
                            </div>
                        </div>
                    </div>

                    <!-- TAB: Sistema -->
                    <div id="tab-system" class="settings-content hidden">
                        <h2 class="text-xl font-bold mb-4">Sistema</h2>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-4 border rounded-xl">
                                <div>
                                    <h4 class="font-bold text-sm">Notificaciones de Navegador</h4>
                                    <p class="text-xs text-gray-500">Recibe alertas incluso si la pestaña no está activa.</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="browser-notify-toggle" class="sr-only peer" onchange="toggleBrowserNotifications()">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            <div class="p-4 bg-blue-50 text-blue-800 text-xs rounded-xl">
                                <strong>Nota:</strong> Las notificaciones internas (toasts) siempre están activas.
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </main>

    <script>
        // --- FIREBASE SETUP & SAFEGUARDS ---
        let auth, db, appId;
        let isCloudAvailable = false;

        try {
            if (typeof __firebase_config !== 'undefined') {
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                isCloudAvailable = true;
            } else {
                console.warn("MyDay OS: Modo Local activado. Firebase no configurado en este entorno.");
                document.getElementById('sync-status-indicator').classList.add('sync-disabled');
                document.getElementById('sync-status-indicator').innerHTML = '<div class="w-1.5 h-1.5 rounded-full bg-red-500"></div> Offline';
                document.getElementById('sync-error-message').classList.remove('hidden');
            }
        } catch (e) {
            console.error("MyDay OS: Error inicializando Firebase:", e);
        }

        // --- Configuración Global ---
        const DAYS_FULL = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
        const COLORS = {
            blue: 'bg-blue-100 text-blue-700 border-blue-200', red: 'bg-red-100 text-red-700 border-red-200',
            green: 'bg-green-100 text-green-700 border-green-200', purple: 'bg-purple-100 text-purple-700 border-purple-200',
            orange: 'bg-orange-100 text-orange-700 border-orange-200', pink: 'bg-pink-100 text-pink-700 border-pink-200',
            gray: 'bg-gray-100 text-gray-700 border-gray-200', yellow: 'bg-yellow-100 text-yellow-800 border-yellow-200'
        };
        const DOT_COLORS = {
            blue: 'bg-blue-500', red: 'bg-red-500', green: 'bg-green-500', purple: 'bg-purple-500',
            orange: 'bg-orange-500', pink: 'bg-pink-500', gray: 'bg-gray-500', yellow: 'bg-yellow-400'
        };

        // --- Estado Inicial ---
        let state = {
            currentDayIndex: new Date().getDay() === 0 ? 6 : new Date().getDay() - 1, // 0=Lunes
            categories: [
                { id: 'c1', name: 'Estudio', color: 'blue' },
                { id: 'c2', name: 'Vida', color: 'orange' },
                { id: 'c3', name: 'Trabajo', color: 'purple' },
                { id: 'c4', name: 'Importante', color: 'red' }
            ],
            schedule: [],
            todos: [],
            settings: {
                bgUrl: 'https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=2564&auto=format&fit=crop',
                browserNotifications: false,
                syncId: null // ID para sincronización
            }
        };

        let unsubscribeSnapshot = null;
        let isSaving = false;

        // --- AUTH INIT ---
        const initAuth = async () => {
            if (!isCloudAvailable) return;
            
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await auth.signInWithCustomToken(__initial_auth_token);
                } else {
                    await auth.signInAnonymously();
                }
            } catch(e) {
                console.error("Auth Error:", e);
                isCloudAvailable = false;
            }
        };
        initAuth();

        // --- Sistema de Persistencia (Híbrido) ---
        function initPersistence() {
            // 1. Cargar LocalStorage primero para inmediatez
            const saved = localStorage.getItem('myDayOS_v3');
            if (saved) {
                const parsed = JSON.parse(saved);
                state = { ...state, ...parsed };
                // Asegurarnos que syncId venga del local si existe
            }
            applySettings();
            
            // 2. Si hay SyncID, conectar a Firebase
            if(state.settings.syncId && isCloudAvailable) {
                activateFirestoreSync(state.settings.syncId);
            }
        }

        function activateFirestoreSync(syncId) {
            if (!isCloudAvailable || !auth.currentUser) return;

            const statusBadge = document.getElementById('sync-status-indicator');
            statusBadge.className = 'sync-badge sync-active';
            statusBadge.innerHTML = `<div class="w-1.5 h-1.5 rounded-full bg-current animate-pulse"></div> Nube`;

            if(unsubscribeSnapshot) unsubscribeSnapshot(); // Limpiar anterior

            // Referencia al documento público compartido (por ID)
            const docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('sync_sessions').doc(syncId);

            unsubscribeSnapshot = docRef.onSnapshot((doc) => {
                if(doc.exists && !isSaving) {
                    const remoteData = doc.data();
                    // Merge cuidadoso
                    state.schedule = remoteData.schedule || [];
                    state.todos = remoteData.todos || [];
                    state.categories = remoteData.categories || state.categories;
                    
                    // Actualizar UI
                    renderApp();
                    updateStats();
                } else if (!doc.exists && state.schedule.length > 0) {
                    // Si no existe en nube pero tenemos local, subimos lo local
                    saveDataToCloud(); 
                }
            }, (error) => {
                console.error("Error sync:", error);
                statusBadge.className = 'sync-badge bg-red-100 text-red-600';
                statusBadge.textContent = 'Error Sync';
            });
        }

        async function saveData() {
            // Guardar en LocalStorage siempre (backup local)
            localStorage.setItem('myDayOS_v3', JSON.stringify(state));
            updateStats();

            // Guardar en Nube si está activo
            if(isCloudAvailable && state.settings.syncId && auth.currentUser) {
                saveDataToCloud();
            }
        }

        // Debounce para no saturar escrituras
        let saveTimeout;
        function saveDataToCloud() {
            if (!isCloudAvailable) return;
            clearTimeout(saveTimeout);
            isSaving = true;
            saveTimeout = setTimeout(async () => {
                try {
                    const docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('sync_sessions').doc(state.settings.syncId);
                    await docRef.set({
                        schedule: state.schedule,
                        todos: state.todos,
                        categories: state.categories,
                        lastUpdated: new Date()
                    });
                } catch(e) { console.error(e); }
                isSaving = false;
            }, 1000);
        }

        function connectSync() {
            if (!isCloudAvailable) {
                alert("La sincronización no está disponible porque Firebase no está configurado en este entorno (ej. ejecutando localmente). Tus datos se guardarán solo en este navegador.");
                return;
            }
            
            const input = document.getElementById('sync-id-input').value.trim();
            if(input.length < 3) return alert("El ID debe tener al menos 3 caracteres");
            
            state.settings.syncId = input;
            saveData(); // Guarda el ID en local
            
            document.getElementById('sync-active-message').classList.remove('hidden');
            activateFirestoreSync(input);
        }

        function applySettings() {
            document.body.style.backgroundImage = `url('${state.settings.bgUrl}')`;
            document.getElementById('browser-notify-toggle').checked = state.settings.browserNotifications;
            if(state.settings.syncId) {
                document.getElementById('sync-id-input').value = state.settings.syncId;
                if (isCloudAvailable) {
                     document.getElementById('sync-active-message').classList.remove('hidden');
                }
            }
        }

        // --- Helpers de Fecha Real ---
        function getCurrentWeekDates() {
            const now = new Date();
            const currentDay = now.getDay(); 
            const diff = now.getDate() - currentDay + (currentDay === 0 ? -6 : 1);
            
            const monday = new Date(now.setDate(diff));
            const weekDates = [];
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);
                weekDates.push(date);
            }
            return weekDates;
        }

        // --- Renderizado Principal ---
        function init() {
            // Inicialización de la persistencia
            // Si la nube está disponible, esperamos al usuario
            if (isCloudAvailable) {
                auth.onAuthStateChanged((user) => {
                    if(user) initPersistence(); 
                });
            } else {
                // Si no, iniciamos persistencia local inmediatamente
                initPersistence();
            }
            
            renderDaySelector();
            renderApp();
            setInterval(updateClock, 1000);
            setInterval(checkNotifications, 60000);
            updateClock();
        }

        function renderApp() {
            renderSchedule();
            renderTodos();
            updateStats();
            lucide.createIcons();
        }

        // --- Renderizado de Horario ---
        function renderDaySelector() {
            const container = document.getElementById('day-selector');
            const weekDates = getCurrentWeekDates();
            
            container.innerHTML = weekDates.map((date, index) => {
                const isSelected = state.currentDayIndex === index;
                const isToday = new Date().toDateString() === date.toDateString();
                const dayName = DAYS_FULL[date.getDay() === 0 ? 0 : date.getDay()].charAt(0); // L, M...
                const dayNumber = date.getDate();
                
                return `
                    <button onclick="setDay(${index})" 
                        class="flex flex-col items-center justify-center min-w-[3rem] h-12 rounded-lg transition-all mx-0.5
                        ${isSelected ? 'bg-white text-blue-600 shadow-sm scale-100 border border-blue-100' : 'text-gray-400 hover:text-gray-600 hover:bg-white/40'}
                        ${isToday && !isSelected ? 'text-blue-400 font-bold' : ''}">
                        <span class="text-[10px] font-bold uppercase">${dayName}</span>
                        <span class="text-sm font-medium ${isToday ? 'bg-blue-100 px-1.5 rounded-full text-blue-600' : ''}">${dayNumber}</span>
                    </button>
                `;
            }).join('');
        }

        function setDay(index) {
            state.currentDayIndex = index;
            renderDaySelector();
            renderSchedule();
        }

        function renderSchedule() {
            const list = document.getElementById('schedule-list');
            const weekDates = getCurrentWeekDates();
            const currentDate = weekDates[state.currentDayIndex];
            
            const dayNameMap = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
            const currentDayName = dayNameMap[currentDate.getDay()];
            
            const dayEvents = state.schedule.filter(s => s.day === currentDayName);
            dayEvents.sort((a, b) => a.time.localeCompare(b.time));

            const displayDate = `${currentDayName} ${currentDate.getDate()}`;
            document.getElementById('schedule-summary').textContent = 
                dayEvents.length === 0 ? `Nada para el ${displayDate}` : `${dayEvents.length} eventos (${displayDate})`;

            list.innerHTML = '';

            if (dayEvents.length === 0) {
                list.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-40 text-gray-500 opacity-60">
                        <i data-lucide="sun" class="w-10 h-10 mb-2 stroke-1"></i>
                        <p class="text-sm">Día libre</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            dayEvents.forEach(item => {
                const category = state.categories.find(c => c.id === item.categoryId) || { color: 'gray', name: '?' };
                const dotColor = DOT_COLORS[category.color] || 'bg-gray-400';

                const div = document.createElement('div');
                div.className = 'group relative flex gap-3 p-3 rounded-xl bg-white/40 hover:bg-white/80 border border-transparent hover:border-blue-100 transition-all cursor-default shadow-sm hover:shadow-md';
                div.innerHTML = `
                    <div class="flex flex-col items-center pt-1 w-12 shrink-0">
                        <span class="text-xs font-black text-gray-700 font-mono bg-white/50 px-1 rounded">${item.time}</span>
                        <div class="h-full w-0.5 bg-gray-300/30 mt-2 rounded-full"></div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-0.5">
                            <span class="w-2 h-2 rounded-full ${dotColor}"></span>
                            <span class="text-[10px] font-bold text-gray-500 uppercase tracking-wider">${category.name}</span>
                        </div>
                        <h4 class="text-gray-800 font-bold text-sm truncate">${item.title}</h4>
                        ${item.desc ? `<p class="text-xs text-gray-500 line-clamp-2 mt-1 leading-relaxed">${item.desc}</p>` : ''}
                    </div>
                    <div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="openModal('schedule', '${item.id}')" class="p-1.5 rounded-md hover:bg-blue-100 text-blue-500 transition"><i data-lucide="pencil" class="w-3 h-3"></i></button>
                        <button onclick="deleteItem('schedule', '${item.id}')" class="p-1.5 rounded-md hover:bg-red-100 text-red-500 transition"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                    </div>
                `;
                list.appendChild(div);
            });
            lucide.createIcons();
        }

        // --- Renderizado de Tareas ---
        function renderTodos() {
            const list = document.getElementById('todo-list');
            list.innerHTML = '';
            
            const sortedTodos = [...state.todos].sort((a, b) => a.completed - b.completed);

            if (sortedTodos.length === 0) {
                 list.innerHTML = `<div class="flex flex-col items-center justify-center h-32 text-gray-400"><p class="text-sm italic">Sin pendientes.</p></div>`;
                 return;
            }

            sortedTodos.forEach(todo => {
                const category = state.categories.find(c => c.id === todo.categoryId) || { color: 'gray', name: 'General' };
                const badgeClass = COLORS[category.color] || COLORS['gray'];

                const div = document.createElement('div');
                div.className = `group flex items-start gap-3 p-3 mb-2 rounded-xl transition-all border ${todo.completed ? 'bg-gray-50/50 border-gray-100 opacity-60' : 'bg-white border-white hover:border-blue-200 hover:shadow-sm'}`;
                
                div.innerHTML = `
                    <label class="custom-checkbox relative flex items-center cursor-pointer pt-1">
                        <input type="checkbox" class="sr-only" ${todo.completed ? 'checked' : ''} onchange="toggleTodo('${todo.id}')">
                        <div class="w-5 h-5 border-2 border-gray-300 rounded-[6px] transition-all flex items-center justify-center bg-white hover:border-blue-400 shadow-sm">
                            <svg class="w-3.5 h-3.5 text-white hidden pointer-events-none" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path></svg>
                        </div>
                    </label>
                    <div class="flex-1 min-w-0 cursor-pointer" onclick="openModal('todo', '${todo.id}')">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-[10px] font-bold px-1.5 py-0.5 rounded border ${badgeClass}">${category.name}</span>
                        </div>
                        <p class="text-sm font-medium text-gray-700 ${todo.completed ? 'line-through decoration-gray-400' : ''} truncate">${todo.text}</p>
                    </div>
                    <button onclick="deleteItem('todo', '${todo.id}')" class="opacity-0 group-hover:opacity-100 p-1.5 text-gray-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                `;
                list.appendChild(div);
            });
            lucide.createIcons();
        }

        // --- Sistema de Notificaciones ---
        function checkNotifications() {
            const now = new Date();
            const currentDayName = DAYS_FULL[now.getDay()]; 
            const currentTime = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });

            const events = state.schedule.filter(s => s.day === currentDayName && s.time === currentTime);

            events.forEach(event => {
                showToast(`Es hora de: ${event.title}`, 'Evento de Agenda');
                
                if (state.settings.browserNotifications && Notification.permission === "granted") {
                    new Notification("MyDay OS", { body: `Es hora de: ${event.title}`, icon: "https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/clock.svg" });
                }
            });
        }

        function showToast(message, title = 'Notificación') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast-notification p-4 flex gap-3 items-start pointer-events-auto cursor-pointer hover:bg-white transition-colors';
            toast.onclick = () => toast.remove();
            
            toast.innerHTML = `
                <div class="bg-blue-100 p-2 rounded-full text-blue-600 shrink-0">
                    <i data-lucide="bell" class="w-5 h-5"></i>
                </div>
                <div class="flex-1">
                    <h4 class="text-sm font-bold text-gray-800">${title}</h4>
                    <p class="text-xs text-gray-600 mt-1">${message}</p>
                </div>
            `;
            
            container.appendChild(toast);
            lucide.createIcons();

            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.4s forwards';
                setTimeout(() => toast.remove(), 400);
            }, 5000);
        }

        function toggleBrowserNotifications() {
            const checkbox = document.getElementById('browser-notify-toggle');
            state.settings.browserNotifications = checkbox.checked;
            saveData();

            if (checkbox.checked && Notification.permission !== "granted") {
                Notification.requestPermission().then(permission => {
                    if (permission !== "granted") {
                        alert("Permiso denegado por el navegador.");
                        checkbox.checked = false;
                        state.settings.browserNotifications = false;
                        saveData();
                    }
                });
            }
        }

        // --- Ajustes Avanzados ---
        function switchSettingsTab(tabId) {
            document.querySelectorAll('.settings-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${tabId}`).classList.remove('hidden');
            
            document.querySelectorAll('.settings-tab-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'shadow-sm', 'text-blue-600');
                if(btn.dataset.tab === tabId) btn.classList.add('bg-white', 'shadow-sm', 'text-blue-600');
            });
        }

        function saveBackground() {
            const url = document.getElementById('bg-url-input').value;
            if(url) {
                state.settings.bgUrl = url;
                saveData();
                applySettings();
                showToast("Fondo actualizado correctamente");
            }
        }

        function setPresetBg(type) {
            const presets = {
                nature: 'https://images.unsplash.com/photo-1472214103451-9374bd1c798e?q=80&w=2070&auto=format&fit=crop',
                dark: 'https://images.unsplash.com/photo-1550684848-fac1c5b4e853?q=80&w=2070&auto=format&fit=crop',
                abstract: 'https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=2564&auto=format&fit=crop'
            };
            state.settings.bgUrl = presets[type];
            document.getElementById('bg-url-input').value = presets[type];
            saveData();
            applySettings();
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "myday_backup.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedState = JSON.parse(e.target.result);
                    state = { ...state, ...importedState };
                    saveData();
                    applySettings();
                    renderApp();
                    showToast("Datos restaurados con éxito");
                    closeSettings();
                } catch(err) {
                    alert("Error al leer el archivo. Asegúrate de que es un JSON válido.");
                }
            };
            reader.readAsText(file);
        }

        function resetAllData() {
            if(confirm("ESTO BORRARÁ TODO. ¿Estás seguro?")) {
                localStorage.removeItem('myDayOS_v3');
                location.reload();
            }
        }

        // --- Stats & Clock ---
        function updateStats() {
            const pending = state.todos.filter(t => !t.completed).length;
            const completed = state.todos.filter(t => t.completed).length;
            const now = new Date();
            const dayName = DAYS_FULL[now.getDay()];
            const todayEvents = state.schedule.filter(s => s.day === dayName).length;

            document.getElementById('pending-count').textContent = pending;
            document.getElementById('completed-count').textContent = completed;
            document.getElementById('today-events-count').textContent = todayEvents;
            document.getElementById('total-todos-badge').textContent = state.todos.length;
        }

        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            const dateFull = now.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('live-clock').textContent = timeStr;
            document.getElementById('live-date-full').textContent = dateFull;
        }

        // --- Modales ---
        function openSettings() {
            document.getElementById('settings-modal').classList.remove('hidden');
            document.getElementById('bg-url-input').value = state.settings.bgUrl;
            switchSettingsTab('general');
            renderCategoriesList();
            if(state.settings.syncId) {
                document.getElementById('sync-id-input').value = state.settings.syncId;
                if (isCloudAvailable) {
                    document.getElementById('sync-active-message').classList.remove('hidden');
                }
            }
        }
        function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }

        let currentModalConfig = { type: null, mode: 'create', id: null };
        function openModal(type, id = null) {
            const modal = document.getElementById('modal');
            const backdrop = document.getElementById('modal-backdrop');
            const content = document.getElementById('modal-content');
            const fields = document.getElementById('form-fields');
            
            currentModalConfig = { type, mode: id ? 'edit' : 'create', id };
            let data = id ? (type === 'schedule' ? state.schedule.find(s=>s.id===id) : state.todos.find(t=>t.id===id)) : null;

            document.getElementById('modal-title').textContent = currentModalConfig.mode === 'create' ? (type==='schedule'?'Nuevo Evento':'Nueva Tarea') : 'Editar';
            document.getElementById('modal-subtitle').textContent = type==='schedule'?'Agenda':'Lista de Tareas';

            const catOptions = state.categories.map(c => `<option value="${c.id}" ${data && data.categoryId === c.id ? 'selected' : ''}>${c.name}</option>`).join('');
            const dayOptions = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'].map(d => `<option value="${d}" ${(data && data.day === d) || (!data && DAYS_FULL[new Date().getDay()] === d) ? 'selected' : ''}>${d}</option>`).join('');

            if(type === 'schedule') {
                fields.innerHTML = `
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Título</label><input type="text" name="title" value="${data?data.title:''}" required class="w-full px-4 py-2 bg-gray-50 border rounded-lg focus:ring-2 focus:ring-blue-100 outline-none"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Día (Repetitivo)</label><select name="day" class="w-full px-4 py-2 bg-gray-50 border rounded-lg outline-none">${dayOptions}</select></div>
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Hora</label><input type="time" name="time" value="${data?data.time:'09:00'}" required class="w-full px-4 py-2 bg-gray-50 border rounded-lg outline-none"></div>
                    </div>
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Categoría</label><select name="categoryId" class="w-full px-4 py-2 bg-gray-50 border rounded-lg outline-none">${catOptions}</select></div>
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Notas</label><textarea name="desc" class="w-full px-4 py-2 bg-gray-50 border rounded-lg resize-none h-20 outline-none">${data?data.desc||'':''}</textarea></div>
                `;
            } else {
                fields.innerHTML = `
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tarea</label><input type="text" name="text" value="${data?data.text:''}" required class="w-full px-4 py-2 bg-gray-50 border rounded-lg focus:ring-2 focus:ring-blue-100 outline-none"></div>
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Categoría</label><select name="categoryId" class="w-full px-4 py-2 bg-gray-50 border rounded-lg outline-none">${catOptions}</select></div>
                `;
            }

            modal.classList.remove('hidden');
            setTimeout(() => { backdrop.classList.remove('opacity-0'); content.classList.remove('opacity-0', 'scale-95'); content.classList.add('scale-100'); }, 10);
        }

        function closeModal() {
            const modal = document.getElementById('modal');
            document.getElementById('modal-backdrop').classList.add('opacity-0');
            document.getElementById('modal-content').classList.remove('scale-100');
            document.getElementById('modal-content').classList.add('opacity-0', 'scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            const fd = new FormData(e.target);
            const { type, mode, id } = currentModalConfig;
            
            if(type === 'schedule') {
                const item = { id: mode==='create'?Date.now().toString():id, title: fd.get('title'), day: fd.get('day'), time: fd.get('time'), categoryId: fd.get('categoryId'), desc: fd.get('desc') };
                if(mode==='create') state.schedule.push(item); else state.schedule[state.schedule.findIndex(i=>i.id===id)] = item;
            } else {
                const item = { id: mode==='create'?Date.now().toString():id, text: fd.get('text'), categoryId: fd.get('categoryId'), completed: mode==='create'?false:state.todos.find(t=>t.id===id).completed };
                if(mode==='create') state.todos.push(item); else state.todos[state.todos.findIndex(i=>i.id===id)] = item;
            }
            saveData(); closeModal(); renderApp();
        }

        function deleteItem(type, id) { if(confirm('¿Eliminar elemento?')) { if(type==='schedule') state.schedule=state.schedule.filter(i=>i.id!==id); else state.todos=state.todos.filter(i=>i.id!==id); saveData(); renderApp(); } }
        function toggleTodo(id) { const t = state.todos.find(i=>i.id===id); if(t) { t.completed = !t.completed; saveData(); renderApp(); } }

        function renderCategoriesList() { document.getElementById('categories-list').innerHTML = state.categories.map(c => `<div class="flex justify-between p-2 bg-gray-50 rounded mb-1"><span class="text-sm ${COLORS[c.color].split(' ')[1]} font-bold">${c.name}</span><button onclick="deleteCategory('${c.id}')" class="text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`).join(''); lucide.createIcons(); }
        function handleAddCategory(e) { e.preventDefault(); const fd = new FormData(e.target); state.categories.push({id:'c'+Date.now(), name:fd.get('catName'), color:fd.get('catColor')}); saveData(); renderCategoriesList(); e.target.reset(); }
        function deleteCategory(id) { if(state.categories.length>1 && confirm('¿Borrar categoría?')) { state.categories = state.categories.filter(c=>c.id!==id); saveData(); renderCategoriesList(); } }

        init();
    </script>
</body>
</html>
